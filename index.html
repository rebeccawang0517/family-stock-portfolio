<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易記錄補登工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAt8QWDrmdYxnIsjEWX6DJ5tHXnDPDSwdM",
            authDomain: "rebecca-financial-platform.firebaseapp.com",
            projectId: "rebecca-financial-platform",
            storageBucket: "rebecca-financial-platform.firebasestorage.app",
            messagingSenderId: "335938745651",
            appId: "1:335938745651:web:2c090e33a72db1a5adfa46"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const authDoc = await getDoc(doc(db, "config", "auth"));
                let allowedEmails = [];
                if (authDoc.exists() && authDoc.data().allowedemail) {
                    allowedEmails = authDoc.data().allowedemail;
                }

                if (allowedEmails.includes(user.email)) {
                    currentUser = user;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');
                    document.getElementById('userEmail').textContent = user.email;
                } else {
                    alert('您沒有權限使用此工具');
                    auth.signOut();
                }
            }
        });

        window.login = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('登入失敗：' + error.message);
            }
        };

        window.logout = () => {
            auth.signOut();
            location.reload();
        };

        window.addTransaction = async () => {
            const date = document.getElementById('txDate').value;
            const type = document.getElementById('txType').value;
            const symbol = document.getElementById('txSymbol').value.toUpperCase().trim();
            const companyName = document.getElementById('txCompany').value.trim();
            const shares = parseFloat(document.getElementById('txShares').value);
            const price = parseFloat(document.getElementById('txPrice').value);
            const fee = parseFloat(document.getElementById('txFee').value) || 0;
            const tax = parseFloat(document.getElementById('txTax').value) || 0;
            const holder = document.getElementById('txHolder').value;
            const platform = document.getElementById('txPlatform').value;
            const region = document.getElementById('txRegion').value;

            if (!date || !type || !symbol || !companyName || !shares || !price || !holder || !platform || !region) {
                alert('請填寫所有必填欄位（標記 * 的欄位）');
                return;
            }

            try {
                const amount = type === '買入' 
                    ? shares * price + fee 
                    : shares * price - fee - tax;

                const transaction = {
                    date: new Date(date).toISOString(),
                    type: type,
                    symbol: symbol,
                    companyName: companyName,
                    shares: shares,
                    price: price,
                    fee: fee,
                    tax: tax,
                    amount: amount,
                    holder: holder,
                    platform: platform,
                    region: region,
                    createdBy: currentUser.email,
                    importedAt: new Date().toISOString(),
                    isHistoricalImport: true
                };

                // 如果是賣出，可以手動輸入已實現損益
                if (type === '賣出') {
                    const profitInput = document.getElementById('txProfit').value;
                    if (profitInput) {
                        transaction.realizedProfit = parseFloat(profitInput);
                    }
                }

                await addDoc(collection(db, 'transactions'), transaction);

                alert(`✅ 交易記錄新增成功！\n\n類型：${type}\n股票：${symbol} - ${companyName}\n股數：${shares}\n價格：${price}\n日期：${date}`);

                // 清空表單
                document.getElementById('txForm').reset();
            } catch (error) {
                console.error('新增失敗:', error);
                alert('❌ 新增失敗：' + error.message);
            }
        };

        window.updateTypeFields = () => {
            const type = document.getElementById('txType').value;
            const taxField = document.getElementById('taxField');
            const profitField = document.getElementById('profitField');

            if (type === '賣出') {
                taxField.classList.remove('hidden');
                profitField.classList.remove('hidden');
            } else {
                taxField.classList.add('hidden');
                profitField.classList.add('hidden');
            }
        };
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen">
    <div id="loginSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-slate-100 mb-2 text-center">交易記錄補登工具</h1>
            <p class="text-slate-400 text-center mb-8">用於補登歷史交易記錄</p>
            
            <button onclick="login()" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-semibold py-3 px-4 rounded-lg transition-colors">
                使用 Google 帳號登入
            </button>
        </div>
    </div>

    <div id="mainSection" class="hidden p-4 md:p-8">
        <div class="max-w-3xl mx-auto">
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-100 mb-2">交易記錄補登工具</h1>
                        <p class="text-slate-400">已登入：<span id="userEmail" class="text-blue-400"></span></p>
                    </div>
                    <button onclick="logout()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition-colors">
                        登出
                    </button>
                </div>
            </div>

            <div class="bg-yellow-900 bg-opacity-30 border border-yellow-700 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">⚠️</span>
                    <div class="text-yellow-200">
                        <strong>重要提醒：</strong>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                            <li>此工具僅用於補登<strong>歷史交易記錄</strong></li>
                            <li>補登的交易<strong>不會</strong>自動更新「明細管理」中的持股數量和成本</li>
                            <li>請確保「明細管理」中的持股數量是<strong>目前實際持有的股數</strong></li>
                            <li>如果需要調整目前持股，請使用主系統的「買入/賣出」功能</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-2xl p-6">
                <h2 class="text-xl font-bold text-slate-100 mb-6">新增歷史交易</h2>
                
                <form id="txForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2">交易日期 *</label>
                            <input type="datetime-local" id="txDate" required
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                        </div>

                        <div>
                            <label class="block text-sm text-slate-300 mb-2">交易類型 *</label>
                            <select id="txType" required onchange="updateTypeFields()"
                                    class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="買入">買入</option>
                                <option value="賣出">賣出</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2">地區 *</label>
                            <select id="txRegion" required
                                    class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="台股">台股</option>
                                <option value="美股">美股</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm text-slate-300 mb-2">股票代號 *</label>
                            <input type="text" id="txSymbol" required placeholder="例如：2330, TSLA"
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-slate-300 mb-2">公司名稱 *</label>
                        <input type="text" id="txCompany" required placeholder="例如：台積電, Tesla"
                               class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2">股數 *</label>
                            <input type="number" id="txShares" required min="1" step="1" placeholder="1000"
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                        </div>

                        <div>
                            <label class="block text-sm text-slate-300 mb-2">價格 *</label>
                            <input type="number" id="txPrice" required min="0" step="0.01" placeholder="150.50"
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2">手續費</label>
                            <input type="number" id="txFee" min="0" step="0.01" value="0" placeholder="28.50"
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                            <div class="text-xs text-slate-500 mt-1">台股約 0.1425%，美股約 $1-$10</div>
                        </div>

                        <div id="taxField" class="hidden">
                            <label class="block text-sm text-slate-300 mb-2">交易稅</label>
                            <input type="number" id="txTax" min="0" step="0.01" value="0" placeholder="45.00"
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                            <div class="text-xs text-slate-500 mt-1">台股約 0.3%，美股無交易稅</div>
                        </div>
                    </div>

                    <div id="profitField" class="hidden">
                        <label class="block text-sm text-slate-300 mb-2">已實現損益（選填）</label>
                        <input type="number" id="txProfit" step="0.01" placeholder="1250.00"
                               class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none" />
                        <div class="text-xs text-slate-500 mt-1">如果知道確切的損益金額可以填寫</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2">持有人 *</label>
                            <select id="txHolder" required
                                    class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="">選擇持有人</option>
                                <option value="Rebecca">Rebecca</option>
                                <option value="Eric">Eric</option>
                                <option value="Ian">Ian</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm text-slate-300 mb-2">交易平台 *</label>
                            <select id="txPlatform" required
                                    class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="複委託">複委託</option>
                                <option value="證券">證券</option>
                                <option value="信託">信託</option>
                            </select>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="button" onclick="addTransaction()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors">
                            ✓ 新增交易記錄
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-4 mt-6">
                <h3 class="font-bold text-blue-300 mb-2">💡 使用說明</h3>
                <ul class="list-disc list-inside text-sm text-blue-200 space-y-1">
                    <li>填寫所有必填欄位（標記 * 的欄位）</li>
                    <li>交易日期可以選擇過去的任何時間</li>
                    <li>賣出交易會自動顯示「交易稅」和「已實現損益」欄位</li>
                    <li>如果不確定手續費和交易稅，可以留空或填 0</li>
                    <li>補登完成後，請回到主系統的「交易記錄」頁面查看</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
