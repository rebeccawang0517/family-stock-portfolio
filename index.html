<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
    // âš ï¸ æ³¨æ„ï¼šé€™è£¡å¤šåŒ¯å…¥äº† getDoc
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    // âš ï¸ æ³¨æ„ï¼šé€™è£¡å¤šåŒ¯å…¥äº† getDoc
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, onSnapshot, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyAt8QWDrmdYxnIsjEWX6DJ5tHXnDPDSwdM",
        authDomain: "rebecca-financial-platform.firebaseapp.com",
        projectId: "rebecca-financial-platform",
        storageBucket: "rebecca-financial-platform.firebasestorage.app",
        messagingSenderId: "335938745651",
        appId: "1:335938745651:web:2c090e33a72db1a5adfa46"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // é€™è£¡ç§»é™¤äº† allowedEmailsï¼Œå› ç‚ºå®ƒç¾åœ¨è—åœ¨ Firestore è£¡äº†
    window.firebaseApp = { auth, db, provider };

    // =========================================================
    // ğŸš€ å®‰å…¨æ€§å¼·åŒ–ç©æœ¨ï¼šæª¢æŸ¥ Firestore ä¸­çš„ç™½åå–®
    // =========================================================
    onAuthStateChanged(auth, async (user) => { // âš ï¸ é€™è£¡å¤šäº† async
        if (user) {
            // 1. å¾ Firestore è®€å–å…è¨±ç™»å…¥çš„ Email åå–®
            const authDoc = await getDoc(doc(db, "config", "auth"));
            // ä½¿ç”¨ ?.allowedEmails ä¾†å®‰å…¨åœ°å–å¾—é™£åˆ—ï¼Œå¦‚æœè®€ä¸åˆ°åå–®å°±ç•¶ä½œç©ºé™£åˆ— []
            // const allowedEmails = authDoc.data()?.allowedemail || []; 
            
            // æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ AND ç¢ºä¿ allowedEmails æ¬„ä½èƒ½è¢«æ­£ç¢ºè®€å–
            let allowedEmails = [];
            if (authDoc.exists() && authDoc.data().allowedemail) {
                // åªæœ‰ç•¶æ–‡ä»¶å­˜åœ¨ä¸”æ¬„ä½ä¸ç‚ºç©ºæ™‚ï¼Œæ‰æŠŠåå–®å­˜é€²ä¾†
                allowedEmails = authDoc.data().allowedemail;
            }

            console.log("authDoc:", authDoc); 
            console.log("authDoc.exists():", authDoc.exists()); 
            console.log("authDoc.data():", authDoc.data());
            console.log("authDoc.data().allowedemail:", authDoc.data().allowedemail);
            console.log("allowedEmails:", allowedEmails);

            console.log("Array.isArray(allowedEmails):", Array.isArray(allowedEmails));
            allowedEmails = allowedEmails.map(item => String(item));
            console.log("Array.isArray(allowedEmails):", Array.isArray(allowedEmails));
            
            // 2. æª¢æŸ¥ç›®å‰ç™»å…¥çš„ Email æ˜¯å¦åœ¨åå–®å…§
            if (allowedEmails.includes(user.email)) {
                
                // âœ… å…è¨±ç™»å…¥çš„é‚è¼¯ (åŸç¨‹å¼ç¢¼çš„å…§å®¹)
                console.log("ç•¶å‰ç™»å…¥ä½¿ç”¨è€…çš„ UID (é‡è¦ï¼):", user.uid); 
                // ... (åœ¨é€™è£¡æ”¾åˆ‡æ›åˆ°ä¸»ç•«é¢çš„ç¨‹å¼ç¢¼ï¼Œä¾‹å¦‚é¡¯ç¤º mainApp éš±è— loginScreen) ...

            } else {
                // âŒ æ‹’çµ•ç™»å…¥ï¼šä¸åœ¨åå–®å…§
                alert('æŠ±æ­‰ï¼Œæ‚¨çš„ Email (' + user.email + ') ä¸åœ¨å…è¨±åå–®å…§ï¼Œè«‹ä½¿ç”¨å…è¨±çš„å¸³è™Ÿç™»å…¥ã€‚');
                signOut(auth); // å¼·åˆ¶ç™»å‡º
            }
        }
        // ... (å¾ŒçºŒçš„ç™»å…¥/ç™»å‡ºç•«é¢åˆ‡æ›é‚è¼¯)
    });
</script>

    <style>
        @media print {
            .no-print { display: none !important; }
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* åˆ†é æ¨™ç±¤æ¨£å¼ */
        .tab-button {
            position: relative;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .tab-button:not(.active):hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* åˆ†é å…§å®¹å‹•ç•« */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æ‰‹æ©Ÿç«¯å„ªåŒ– */
        @media (max-width: 768px) {
            /* éš±è—æ¡Œé¢ç‰ˆæ–°å¢è¡Œ */
            .desktop-add-row {
                display: none !important;
            }
            
            /* è¡¨æ ¼åœ¨æ‰‹æ©Ÿä¸Šçš„å„ªåŒ– */
            table {
                font-size: 12px;
            }
            
            /* æµ®å‹•æ–°å¢æŒ‰éˆ• */
            .mobile-fab {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                font-size: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                z-index: 1000;
                border: none;
                cursor: pointer;
            }
            
            /* æ‰‹æ©Ÿç«¯å½ˆå‡ºè¡¨å–® */
            .mobile-form-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                display: flex;
                align-items: flex-end;
                padding: 0;
            }
            
            .mobile-form-container {
                background: #1e293b;
                border-radius: 20px 20px 0 0;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                padding: 20px;
                animation: slideUp 0.3s ease-out;
            }
            
            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }
        }
        
        /* æ¡Œé¢ç«¯éš±è—æ‰‹æ©Ÿå°ˆç”¨å…ƒç´  */
        @media (min-width: 769px) {
            .mobile-fab {
                display: none !important;
            }
            .mobile-only {
                display: none !important;
            }
        }
        
        /* åˆ†ææ¨¡æ…‹æ¡† */
        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .analysis-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.5);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-slate-100 mb-2 text-center">å®¶æ—è‚¡ç¥¨ç®¡ç†ç³»çµ±</h1>
            <p class="text-slate-400 text-center mb-8">Professional Portfolio Management</p>
            
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                
                <p class="text-sm text-slate-400 text-center">åƒ…é™ Rebeccaã€Eric ä½¿ç”¨</p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-2xl p-6 mb-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-100 mb-2">å®¶æ—è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</h1>
                        <p class="text-slate-400">å·²ç™»å…¥ï¼š<span id="userEmail" class="text-blue-400"></span></p>
                    </div>
                    
                    <div class="flex items-center gap-3 flex-wrap no-print">
                        <button onclick="updateAllPricesAndRate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ”„ æ›´æ–°
                        </button>
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“¥ åŒ¯å‡º Excel
                        </button>
                        <button onclick="window.print()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ–¨ï¸ åˆ—å°
                        </button>
                        <button onclick="logout()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†é æ¨™ç±¤ -->
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 mb-6 no-print">
                <div class="flex gap-2">
                    <button onclick="switchTab('overview')" id="tabOverview" class="tab-button active flex-1 px-6 py-3 rounded-lg font-semibold text-lg transition-all">
                        ç¸½è¦½
                    </button>
                    <button onclick="switchTab('detail')" id="tabDetail" class="tab-button flex-1 px-6 py-3 rounded-lg font-semibold text-lg text-slate-400 transition-all">
                        æ˜ç´°ç®¡ç†
                    </button>
                </div>
            </div>

            <!-- ç¬¬ä¸€é ï¼šç¸½è¦½ -->
            <div id="overviewTab" class="tab-content active">
                <!-- åŒ¯ç‡è¨­å®š -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-4 mb-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-4">
                            <span class="text-slate-300 font-medium">åŒ¯ç‡ USD/TWD</span>
                            <input type="number" id="usdRate" value="31.5" step="0.01" class="bg-slate-700 text-slate-100 px-3 py-1 rounded border border-slate-600 focus:border-blue-500 focus:outline-none w-24 text-right font-mono" onchange="updateStats()" />
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center gap-2 text-slate-300">
                                <input type="checkbox" id="autoRefresh" class="rounded" checked onchange="toggleAutoRefresh(this.checked)">
                                <span>è‡ªå‹•æ›´æ–° (æ¯5åˆ†é˜)</span>
                            </label>
                            <span id="lastUpdate" class="text-slate-500 text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- ç¸½æŠ•è³‡çµ±è¨ˆ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-slate-400 text-sm mb-1">ç¸½æŠ•è³‡æˆæœ¬</div>
                        <div id="totalCost" class="text-2xl font-bold text-slate-100">TWD 0</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-slate-400 text-sm mb-1">ç¸½å¸‚å€¼</div>
                        <div id="totalValue" class="text-2xl font-bold text-slate-100">TWD 0</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-slate-400 text-sm mb-1">ç¸½æç›Š</div>
                        <div id="totalProfit" class="text-2xl font-bold">TWD 0</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <div class="text-slate-400 text-sm mb-1">ç¸½å ±é…¬ç‡</div>
                        <div id="totalReturn" class="text-2xl font-bold">0%</div>
                    </div>
                </div>

                <!-- æŒè‚¡çµ±è¨ˆç¸½è¦½ -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-blue-500 rounded-lg shadow-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-slate-100 flex items-center gap-2">
                            <span>ğŸ“Š</span>
                            <span>æŒè‚¡çµ±è¨ˆç¸½è¦½</span>
                        </h2>
                        <div class="text-sm text-slate-400">
                            ğŸ’¡ é»æ“Šå…¬å¸åç¨±æŸ¥çœ‹å¤æ™®å€¼åˆ†æ
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-900 border-b-2 border-blue-400">
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">åœ°å€</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">è‚¡ç¥¨ä»£è™Ÿ</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">å…¬å¸åç¨±</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ç¸½è‚¡æ•¸</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">å¹³å‡æˆæœ¬åƒ¹</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ç¸½æŠ•è³‡æˆæœ¬</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ç¾åƒ¹</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">æ¼²è·Œå¹…</th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ç¸½ç¾å€¼<br/><span class="text-xs text-slate-400">(åŸå¹£åˆ¥)</span></th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ç¸½ç¾å€¼<br/><span class="text-xs text-slate-400">(TWD)</span></th>
                                    <th class="px-4 py-3 text-center text-blue-300 font-semibold">ä½”æ¯” (ä¾TWDç¾å€¼)</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <!-- çµ±è¨ˆè³‡æ–™æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç¸½è¦½é èªªæ˜ -->
                <div class="mt-6 bg-gradient-to-r from-blue-900 to-purple-900 bg-opacity-30 border border-blue-700 border-opacity-50 rounded-lg p-4 text-sm text-blue-200">
                    <strong>ğŸ“Š ç¸½è¦½é åŠŸèƒ½ï¼š</strong> 
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>æŸ¥çœ‹æ•´é«”æŠ•è³‡çµ„åˆè¡¨ç¾ï¼ˆç¸½æˆæœ¬ã€ç¸½å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡ï¼‰</li>
                        <li>ç€è¦½å„æª”è‚¡ç¥¨çš„åˆä½µæŒè‚¡çµ±è¨ˆï¼ˆä¸åˆ†æŒæœ‰äººå’Œå¹³å°ï¼‰</li>
                        <li><strong class="text-yellow-300">é»æ“Šå…¬å¸åç¨±å¯æŸ¥çœ‹è©²è‚¡ç¥¨çš„å¤æ™®å€¼åˆ†æï¼ˆ3å¹´ã€5å¹´ã€10å¹´æœŸï¼‰</strong></li>
                        <li>ä½”æ¯”é¡¯ç¤ºç‚ºè©²è‚¡ç¥¨ç¾å€¼åœ¨æ•´é«”æŠ•è³‡çµ„åˆä¸­çš„æ¯”é‡</li>
                        <li>çµ±è¨ˆè¡¨æ ¼æŒ‰ç¾å€¼ç”±å¤§åˆ°å°æ’åº</li>
                    </ul>
                </div>
            </div>

            <!-- ç¬¬äºŒé ï¼šæ˜ç´°ç®¡ç† -->
            <div id="detailTab" class="tab-content">
                <!-- ç¯©é¸å™¨ -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-4 mb-6">
                    <div class="flex items-center gap-4 flex-wrap">
                        <span class="text-slate-300 font-medium">ç¯©é¸ï¼š</span>
                        <select id="filterRegion" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                            <option value="">å…¨éƒ¨åœ°å€</option>
                            <option value="å°è‚¡">å°è‚¡</option>
                            <option value="ç¾è‚¡">ç¾è‚¡</option>
                        </select>
                        <select id="filterHolder" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                            <option value="">å…¨éƒ¨æŒæœ‰äºº</option>
                            <option value="Rebecca">Rebecca</option>
                            <option value="Eric">Eric</option>
                            <option value="Ian">Ian</option>
                        </select>
                        <select id="filterPlatform" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                            <option value="">å…¨éƒ¨å¹³å°</option>
                            <option value="è¤‡å§”è¨—">è¤‡å§”è¨—</option>
                            <option value="è­‰åˆ¸">è­‰åˆ¸</option>
                            <option value="ä¿¡è¨—">ä¿¡è¨—</option>
                        </select>
                        <button onclick="clearFilters()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded">æ¸…é™¤ç¯©é¸</button>
                    </div>
                </div>

                <!-- æŒè‚¡æ˜ç´°è¡¨æ ¼ -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-900 border-b border-slate-700">
                                    <th class="px-4 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" style="min-width: 60px;" onclick="sortTable('region')">
                                        åœ°å€ <span class="sort-indicator text-xs" id="sort-region">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('companyName')">
                                        å…¬å¸ <span class="sort-indicator text-xs" id="sort-companyName">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('symbol')">
                                        ä»£è™Ÿ <span class="sort-indicator text-xs" id="sort-symbol">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('shares')">
                                        è‚¡æ•¸ <span class="sort-indicator text-xs" id="sort-shares">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('costPrice')">
                                        æˆæœ¬åƒ¹ <span class="sort-indicator text-xs" id="sort-costPrice">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('investmentCost')">
                                        æŠ•è³‡æˆæœ¬ <span class="sort-indicator text-xs" id="sort-investmentCost">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('currentPrice')">
                                        ç¾åƒ¹ <span class="sort-indicator text-xs" id="sort-currentPrice">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('currentValue')">
                                        ç¾å€¼ <span class="sort-indicator text-xs" id="sort-currentValue">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('returnRate')">
                                        å ±é…¬ç‡ <span class="sort-indicator text-xs" id="sort-returnRate">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('holder')">
                                        æŒæœ‰äºº <span class="sort-indicator text-xs" id="sort-holder">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 cursor-pointer hover:bg-slate-800 transition-colors" onclick="sortTable('platform')">
                                        å¹³å° <span class="sort-indicator text-xs" id="sort-platform">â†•</span>
                                    </th>
                                    <th class="px-3 py-3 text-center text-slate-300 no-print">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="stockTableBody">
                                <tr class="desktop-add-row bg-blue-900 bg-opacity-20 border-b-2 border-blue-500 no-print">
                                    <td class="px-4 py-2">
                                        <select id="newRegion" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                            <option>å°è‚¡</option>
                                            <option>ç¾è‚¡</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" id="newCompany" placeholder="å…¬å¸åç¨±" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm" readonly />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" id="newSymbol" placeholder="ä»£è™Ÿ" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm font-mono" style="text-transform: uppercase;" onchange="fetchCompanyName()" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="number" id="newShares" placeholder="è‚¡æ•¸" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-center" oninput="calculateFromFields()" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="number" id="newCostPrice" placeholder="æˆæœ¬åƒ¹" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-center" oninput="calculateFromFields()" step="0.01" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="number" id="newCost" placeholder="æˆæœ¬" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-center" oninput="calculateFromFields()" />
                                    </td>
                                    <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•ç²å–</td>
                                    <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•</td>
                                    <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•</td>
                                    <td class="px-3 py-2">
                                        <select id="newHolder" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                            <option value="">é¸æ“‡</option>
                                            <option>Rebecca</option>
                                            <option>Eric</option>
                                            <option>Ian</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2">
                                        <select id="newPlatform" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                            <option>è¤‡å§”è¨—</option>
                                            <option>è­‰åˆ¸</option>
                                            <option>ä¿¡è¨—</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <button onclick="addStock()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded">æ–°å¢</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-6 bg-blue-900 bg-opacity-30 border border-blue-700 border-opacity-50 rounded-lg p-4 text-sm text-blue-200">
                    <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong> 
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>æ­¤é é¢é¡¯ç¤ºæ‰€æœ‰æŒè‚¡çš„è©³ç´°æ˜ç´°ï¼ˆåŒ…å«æŒæœ‰äººå’Œå¹³å°è³‡è¨Šï¼‰</li>
                        <li>è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿå¾Œæœƒè‡ªå‹•ç²å–å…¬å¸åç¨±</li>
                        <li>è¼¸å…¥æˆæœ¬åƒ¹+è‚¡æ•¸æœƒè‡ªå‹•è¨ˆç®—æŠ•è³‡æˆæœ¬ï¼Œæˆ–è¼¸å…¥æŠ•è³‡æˆæœ¬+è‚¡æ•¸æœƒè‡ªå‹•è¨ˆç®—æˆæœ¬åƒ¹</li>
                        <li>ç³»çµ±æœƒè‡ªå‹•ç²å–æœ€æ–°è‚¡åƒ¹ï¼ˆè‹¥æœªé–‹ç›¤å‰‡é¡¯ç¤ºå‰ä¸€æ”¶ç›¤åƒ¹ï¼‰</li>
                        <li>å¯ä½¿ç”¨ä¸Šæ–¹ç¯©é¸åŠŸèƒ½æŸ¥çœ‹ç‰¹å®šåœ°å€ã€æŒæœ‰äººæˆ–å¹³å°çš„è‚¡ç¥¨</li>
                        <li><strong class="text-yellow-300">ğŸ’¡ åˆ‡æ›åˆ°ã€Œç¸½è¦½ã€é é¢æŸ¥çœ‹æ•´é«”çµ±è¨ˆå’Œå¤æ™®å€¼åˆ†æ</strong></li>
                    </ul>
                </div>
            </div>
            
            <!-- æ‰‹æ©Ÿç«¯æµ®å‹•æ–°å¢æŒ‰éˆ• -->
            <button class="mobile-fab no-print" onclick="openMobileForm()">
                +
            </button>
            
            <!-- æ‰‹æ©Ÿç«¯æ–°å¢è¡¨å–®å½ˆçª— -->
            <div id="mobileFormOverlay" class="mobile-form-overlay no-print" style="display: none;" onclick="closeMobileForm(event)">
                <div class="mobile-form-container" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-100">æ–°å¢è‚¡ç¥¨</h2>
                        <button onclick="closeMobileForm()" class="text-slate-400 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">åœ°å€</label>
                            <select id="mobileRegion" class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600">
                                <option>å°è‚¡</option>
                                <option>ç¾è‚¡</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">è‚¡ç¥¨ä»£è™Ÿ *</label>
                            <input type="text" id="mobileSymbol" placeholder="ä¾‹å¦‚ï¼š2330 æˆ– AAPL" 
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600 font-mono" 
                                   style="text-transform: uppercase;"
                                   onchange="fetchCompanyNameMobile()" />
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">å…¬å¸åç¨±</label>
                            <input type="text" id="mobileCompany" placeholder="è‡ªå‹•ç²å–" 
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600" 
                                   readonly />
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">è‚¡æ•¸ *</label>
                            <input type="number" id="mobileShares" placeholder="æŒæœ‰è‚¡æ•¸" 
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600" 
                                   onchange="calculateCostMobile()" />
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">æˆæœ¬åƒ¹</label>
                            <input type="number" id="mobileCostPrice" placeholder="æ¯è‚¡æˆæœ¬" 
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600" 
                                   step="0.01"
                                   onchange="calculateCostMobile()" />
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">æŠ•è³‡æˆæœ¬</label>
                            <input type="number" id="mobileCost" placeholder="ç¸½æŠ•è³‡é‡‘é¡" 
                                   class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600"
                                   onchange="calculateCostPriceMobile()" />
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">æŒæœ‰äºº *</label>
                            <select id="mobileHolder" class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600">
                                <option value="">è«‹é¸æ“‡</option>
                                <option>Rebecca</option>
                                <option>Eric</option>
                                <option>Ian</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-slate-300 text-sm mb-2">å¹³å°</label>
                            <select id="mobilePlatform" class="w-full bg-slate-700 text-slate-100 px-4 py-3 rounded-lg border border-slate-600">
                                <option>è¤‡å§”è¨—</option>
                                <option>è­‰åˆ¸</option>
                                <option>ä¿¡è¨—</option>
                            </select>
                        </div>
                        
                        <div class="pt-4 space-y-3">
                            <button onclick="addStockMobile()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg">
                                âœ“ æ–°å¢è‚¡ç¥¨
                            </button>
                            <button onclick="closeMobileForm()" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { auth, db, provider, allowedEmails } = window.firebaseApp;
        let currentUser = null;
        let stocks = [];
        let filteredStocks = [];
        let autoRefreshInterval = null;

        import { onAuthStateChanged, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        onAuthStateChanged(auth, async (user) => {
            if (user && allowedEmails.includes(user.email)) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                await loadStocks();
                
                // é¦–æ¬¡åŠ è¼‰æ™‚æ›´æ–°åŒ¯ç‡
                await fetchExchangeRate();
                
                // å•Ÿå‹•è‡ªå‹•åˆ·æ–°
                if (document.getElementById('autoRefresh').checked) {
                    toggleAutoRefresh(true);
                }
            } else if (user) {
                alert('æ‚¨çš„å¸³è™Ÿç„¡æ¬Šè¨ªå•æ­¤ç³»çµ±');
                await auth.signOut();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // === ä¿®æ­£ç‰ˆï¼šç²å–è‚¡ç¥¨è³‡è¨Šï¼ˆæ”¯æ´å‚µåˆ¸ ETF + é‡è©¦æ©Ÿåˆ¶ + æ¼²è·Œå¹…ï¼‰===
        async function fetchStockInfo(symbol, region, retryCount = 0) {
            const maxRetries = 3;
            
            try {
                let apiSymbol = symbol;
                
                if (region === 'å°è‚¡') {
                    // å‚µåˆ¸ ETF ä½¿ç”¨ .TWO (æ«ƒè²·ä¸­å¿ƒ)ï¼Œä¸€èˆ¬å°è‚¡ä½¿ç”¨ .TW (è­‰äº¤æ‰€)
                    if (symbol.startsWith('00') && symbol.includes('B')) {
                        apiSymbol = symbol + '.TWO';
                    } else {
                        apiSymbol = symbol + '.TW';
                    }
                }
                
                console.log(`å˜—è©¦ç²å– ${symbol} çš„è³‡è¨Š (ç¬¬ ${retryCount + 1} æ¬¡)ï¼ŒAPI ä»£è™Ÿ: ${apiSymbol}`);
                
                // ä½¿ç”¨ CORS ä»£ç†ä¾†ç¹éç€è¦½å™¨é™åˆ¶
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${apiSymbol}`;
                const url = corsProxy + encodeURIComponent(apiUrl);
                
                const response = await fetch(url, {
                    method: 'GET',
                    timeout: 10000 // 10ç§’è¶…æ™‚
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    
                    // ç²å–åƒ¹æ ¼ï¼ˆå„ªå…ˆä½¿ç”¨ regularMarketPriceï¼Œå¦å‰‡ä½¿ç”¨ previousCloseï¼‰
                    const price = meta.regularMarketPrice || meta.chartPreviousClose || meta.previousClose;
                    
                    // ç²å–å‰ä¸€æ—¥æ”¶ç›¤åƒ¹
                    const previousClose = meta.chartPreviousClose || meta.previousClose;
                    
                    // è¨ˆç®—æ¼²è·Œå¹…
                    let changePercent = 0;
                    if (previousClose && price && previousClose !== 0) {
                        changePercent = ((price - previousClose) / previousClose) * 100;
                    }
                    
                    if (!price || price <= 0) {
                        throw new Error(`${symbol} åƒ¹æ ¼ç„¡æ•ˆ: ${price}`);
                    }
                    
                    // ç²å–å…¬å¸åç¨± - é è¨­ä½¿ç”¨è‚¡ç¥¨ä»£è™Ÿ
                    let companyName = symbol;
                    
                    // å°è‚¡å¸¸è¦‹å…¬å¸åç¨±æ˜ å°„ï¼ˆä¿®æ­£ Yahoo Finance è³‡æ–™ä¸æº–ç¢ºçš„å•é¡Œï¼‰
                    if (region === 'å°è‚¡') {
                        const taiwanStocks = {
                            // === ETF ===
                            '0050': 'å…ƒå¤§å°ç£50',
                            '0056': 'å…ƒå¤§é«˜è‚¡æ¯',
                            '00679B': 'å…ƒå¤§ç¾å‚µ20å¹´',
                            '00687B': 'åœ‹æ³°20å¹´ç¾å‚µ',
                            '00697B': 'å…ƒå¤§ç¾å‚µ7-10',
                            '00720B': 'å…ƒå¤§æŠ•è³‡ç´šå…¬å¸å‚µ',
                            
                            // === 0050 & 0056 ä¸»è¦æˆåˆ†è‚¡ ===
                            '2330': 'å°ç©é›»',
                            '2317': 'é´»æµ·',
                            '2454': 'è¯ç™¼ç§‘',
                            '2412': 'ä¸­è¯é›»',
                            '2308': 'å°é”é›»',
                            '2882': 'åœ‹æ³°é‡‘',
                            '2881': 'å¯Œé‚¦é‡‘',
                            '2891': 'ä¸­ä¿¡é‡‘',
                            '2886': 'å…†è±é‡‘',
                            '2884': 'ç‰å±±é‡‘',
                            '2885': 'å…ƒå¤§é‡‘',
                            '2892': 'ç¬¬ä¸€é‡‘',
                            '2887': 'å°æ–°é‡‘',
                            '2883': 'é–‹ç™¼é‡‘',
                            '5880': 'åˆåº«é‡‘',
                            '2880': 'è¯å—é‡‘',
                            '2888': 'æ–°å…‰é‡‘',
                            '2890': 'æ°¸è±é‡‘',
                            '5876': 'ä¸Šæµ·å•†éŠ€',
                            '2801': 'å½°éŠ€',
                            '2809': 'äº¬åŸéŠ€',
                            
                            // === é›»å­è‚¡ ===
                            '3711': 'æ—¥æœˆå…‰æŠ•æ§',
                            '2382': 'å»£é”',
                            '2303': 'è¯é›»',
                            '2357': 'è¯ç¢©',
                            '2301': 'å…‰å¯¶ç§‘',
                            '2395': 'ç ”è¯',
                            '2408': 'å—äºç§‘',
                            '3008': 'å¤§ç«‹å…‰',
                            '2409': 'å‹é”',
                            '2345': 'æ™ºé‚¦',
                            '2327': 'åœ‹å·¨',
                            '3034': 'è¯è© ',
                            '6669': 'ç·¯ç©',
                            '6415': 'çŸ½åŠ›-KY',
                            '3017': 'å¥‡é‹',
                            '2376': 'æŠ€å˜‰',
                            '2474': 'å¯æˆ',
                            '3045': 'å°ç£å¤§',
                            '4904': 'é å‚³',
                            '4938': 'å’Œç¢©',
                            '2324': 'ä»å¯¶',
                            '2356': 'è‹±æ¥­é”',
                            '3231': 'ç·¯å‰µ',
                            '6770': 'åŠ›ç©é›»',
                            '2371': 'å¤§åŒ',
                            '2353': 'å®ç¢',
                            '2377': 'å¾®æ˜Ÿ',
                            '3443': 'å‰µæ„',
                            '3661': 'ä¸–èŠ¯-KY',
                            '6781': 'AES-KY',
                            '3529': 'åŠ›æ—º',
                            '6533': 'æ™¶å¿ƒç§‘',
                            
                            // === å‚³ç”¢è‚¡ ===
                            '1301': 'å°å¡‘',
                            '1303': 'å—äº',
                            '1326': 'å°åŒ–',
                            '6505': 'å°å¡‘åŒ–',
                            '1101': 'å°æ³¥',
                            '1102': 'äºæ³¥',
                            '2002': 'ä¸­é‹¼',
                            '2207': 'å’Œæ³°è»Š',
                            '2105': 'æ­£æ–°',
                            '2912': 'çµ±ä¸€è¶…',
                            '1216': 'çµ±ä¸€',
                            '9904': 'å¯¶æˆ',
                            '9910': 'è±æ³°',
                            '2615': 'è¬æµ·',
                            '2609': 'é™½æ˜',
                            '2603': 'é•·æ¦®',
                            '5871': 'ä¸­ç§Ÿ-KY',
                            '9921': 'å·¨å¤§',
                            '2049': 'ä¸ŠéŠ€',
                            '1590': 'äºå¾·å®¢-KY',
                            '2204': 'ä¸­è¯',
                            '1476': 'å„’é´»',
                            '1477': 'èšé™½',
                            '2201': 'è£•éš†',
                            '2227': 'è£•æ—¥è»Š',
                            '2542': 'èˆˆå¯Œç™¼',
                            '5522': 'é é›„',
                            '2535': 'é”æ¬£å·¥',
                            '9945': 'æ½¤æ³°æ–°',
                            '2547': 'æ—¥å‹ç”Ÿ',
                            
                            // === å…¶ä»–å¸¸è¦‹å€‹è‚¡ ===
                            '2344': 'è¯é‚¦é›»',
                            '2337': 'æ—ºå®',
                            '2352': 'ä½³ä¸–é”',
                            '2354': 'é´»æº–',
                            '2360': 'è‡´èŒ‚',
                            '2379': 'ç‘æ˜±',
                            '2439': 'ç¾å¾‹',
                            '2449': 'äº¬å…ƒé›»å­',
                            '2458': 'ç¾©éš†',
                            '6121': 'æ–°æ™®',
                            '6176': 'ç‘å„€',
                            '6239': 'åŠ›æˆ',
                            '6271': 'åŒæ¬£é›»',
                            '8046': 'å—é›»',
                            '2347': 'è¯å¼·',
                            '2493': 'æšåš',
                            '3702': 'å¤§è¯å¤§',
                            '4943': 'åº·æ§-KY',
                            '6116': 'å½©æ™¶',
                            '6213': 'è¯èŒ‚',
                            '8131': 'ç¦æ‡‹ç§‘'
                        };
                        
                        // å¦‚æœåœ¨æ¸…å–®ä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨æ¸…å–®åç¨±ï¼›å¦å‰‡ä¿æŒä½¿ç”¨ä»£è™Ÿ
                        if (taiwanStocks[symbol]) {
                            companyName = taiwanStocks[symbol];
                        }
                    } else {
                        // ç¾è‚¡ï¼šå„ªå…ˆä½¿ç”¨ Yahoo çš„åç¨±ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨ä»£è™Ÿ
                        companyName = meta.longName || meta.shortName || symbol;
                    }
                    
                    console.log(`âœ“ æˆåŠŸç²å– ${symbol}: åƒ¹æ ¼=${price}, åç¨±=${companyName}, æ¼²è·Œå¹…=${changePercent.toFixed(2)}%`);
                    
                    return {
                        price: Math.abs(price), // ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
                        companyName: companyName,
                        changePercent: changePercent // æ–°å¢æ¼²è·Œå¹…
                    };
                }
                
                throw new Error(`${symbol} ç„¡æ³•å¾ API ç²å–æ•¸æ“š`);
                
            } catch (error) {
                console.error(`âœ— ç²å– ${symbol} è³‡è¨Šå¤±æ•— (ç¬¬ ${retryCount + 1} æ¬¡):`, error.message);
                
                // å¦‚æœé‚„æœ‰é‡è©¦æ¬¡æ•¸ï¼Œç­‰å¾…å¾Œé‡è©¦
                if (retryCount < maxRetries) {
                    const waitTime = (retryCount + 1) * 1000; // éå¢ç­‰å¾…æ™‚é–“ï¼š1ç§’ã€2ç§’ã€3ç§’
                    console.log(`â³ ç­‰å¾… ${waitTime/1000} ç§’å¾Œé‡è©¦...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                    return fetchStockInfo(symbol, region, retryCount + 1);
                }
                
                // é‡è©¦æ¬¡æ•¸ç”¨ç›¡ï¼Œè¿”å› null
                console.error(`âŒ ${symbol} åœ¨é‡è©¦ ${maxRetries} æ¬¡å¾Œä»ç„¶å¤±æ•—`);
                return null;
            }
        }

        // ç²å–åŒ¯ç‡ï¼ˆåŠ å…¥é‡è©¦æ©Ÿåˆ¶ï¼‰
        async function fetchExchangeRate(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                console.log(`å˜—è©¦ç²å–åŒ¯ç‡ (ç¬¬ ${retryCount + 1} æ¬¡)`);
                
                // ä½¿ç”¨ CORS ä»£ç†
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const apiUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/USDTWD=X';
                const url = corsProxy + encodeURIComponent(apiUrl);
                
                const response = await fetch(url, {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const rate = data.chart.result[0].meta.regularMarketPrice || data.chart.result[0].meta.previousClose;
                    if (rate) {
                        document.getElementById('usdRate').value = Math.abs(rate).toFixed(2);
                        updateStats();
                        console.log(`âœ“ æˆåŠŸç²å–åŒ¯ç‡: ${rate}`);
                        return true;
                    }
                }
                
                throw new Error('ç„¡æ³•ç²å–åŒ¯ç‡æ•¸æ“š');
                
            } catch (error) {
                console.error(`âœ— ç²å–åŒ¯ç‡å¤±æ•— (ç¬¬ ${retryCount + 1} æ¬¡):`, error.message);
                
                // å¦‚æœé‚„æœ‰é‡è©¦æ¬¡æ•¸ï¼Œç­‰å¾…å¾Œé‡è©¦
                if (retryCount < maxRetries) {
                    const waitTime = (retryCount + 1) * 1000;
                    console.log(`â³ ç­‰å¾… ${waitTime/1000} ç§’å¾Œé‡è©¦...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                    return fetchExchangeRate(retryCount + 1);
                }
                
                // é‡è©¦æ¬¡æ•¸ç”¨ç›¡
                console.error(`âŒ åŒ¯ç‡åœ¨é‡è©¦ ${maxRetries} æ¬¡å¾Œä»ç„¶å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼`);
                return false;
            }
        }

        // ç²å–å…¬å¸åç¨±ï¼ˆåœ¨è¼¸å…¥ä»£è™Ÿæ™‚ï¼‰
        window.fetchCompanyName = async function() {
            const symbolInput = document.getElementById('newSymbol');
            const regionSelect = document.getElementById('newRegion');
            const companyInput = document.getElementById('newCompany');
            
            let symbol = symbolInput.value.toUpperCase().trim();
            
            if (!symbol) return;
            
            // === è‡ªå‹•åˆ¤æ–·åœ°å€ ===
            // å°è‚¡ï¼šç´”æ•¸å­—é–‹é ­ï¼ˆ2330, 0050, 00679Bï¼‰
            // ç¾è‚¡ï¼šå­—æ¯é–‹é ­ï¼ˆAAPL, TSLAï¼‰
            if (/^\d/.test(symbol)) {
                // æ•¸å­—é–‹é ­ = å°è‚¡
                regionSelect.value = 'å°è‚¡';
            } else if (/^[A-Z]/.test(symbol)) {
                // å­—æ¯é–‹é ­ = ç¾è‚¡
                regionSelect.value = 'ç¾è‚¡';
            }
            
            const region = regionSelect.value;
            
            companyInput.value = 'æ­£åœ¨ç²å–...';
            
            const info = await fetchStockInfo(symbol, region);
            if (info) {
                companyInput.value = info.companyName;
            } else {
                companyInput.value = '';
                alert(`âŒ ç„¡æ³•ç²å– ${symbol} çš„è³‡è¨Š\n\nå¯èƒ½åŸå› ï¼š\n1. è‚¡ç¥¨ä»£è™Ÿä¸æ­£ç¢º\n2. è©²è‚¡ç¥¨å·²ä¸‹å¸‚\n3. ç¶²è·¯é€£ç·šå•é¡Œ\n\nç³»çµ±å·²è‡ªå‹•é‡è©¦ 3 æ¬¡ï¼Œè«‹æª¢æŸ¥ä»£è™Ÿå¾Œå†è©¦ã€‚`);
            }
        };

        // æ™ºèƒ½è¨ˆç®—å‡½æ•¸ - æ ¹æ“šå·²å¡«å¯«çš„å­—æ®µè‡ªå‹•è¨ˆç®—ç¼ºå°‘çš„å­—æ®µ
        window.calculateFromFields = function() {
            const costPriceInput = document.getElementById('newCostPrice');
            const sharesInput = document.getElementById('newShares');
            const costInput = document.getElementById('newCost');
            
            const costPrice = parseFloat(costPriceInput.value) || 0;
            const shares = parseFloat(sharesInput.value) || 0;
            const cost = parseFloat(costInput.value) || 0;
            
            // è¨ˆç®—é‚è¼¯ï¼šä»»æ„å…©å€‹æœ‰å€¼ï¼Œè¨ˆç®—ç¬¬ä¸‰å€‹
            if (costPrice && shares && !cost) {
                // æœ‰æˆæœ¬åƒ¹å’Œè‚¡æ•¸ï¼Œè¨ˆç®—æŠ•è³‡æˆæœ¬
                costInput.value = (costPrice * shares).toFixed(2);
            } else if (costPrice && cost && !shares) {
                // æœ‰æˆæœ¬åƒ¹å’ŒæŠ•è³‡æˆæœ¬ï¼Œè¨ˆç®—è‚¡æ•¸
                sharesInput.value = Math.floor(cost / costPrice);
            } else if (shares && cost && !costPrice) {
                // æœ‰è‚¡æ•¸å’ŒæŠ•è³‡æˆæœ¬ï¼Œè¨ˆç®—æˆæœ¬åƒ¹
                costPriceInput.value = (cost / shares).toFixed(2);
            } else if (costPrice && shares && cost) {
                // ä¸‰å€‹éƒ½æœ‰å€¼æ™‚ï¼Œä»¥æœ€å¾Œä¿®æ”¹çš„ç‚ºæº–ï¼Œæ›´æ–°æŠ•è³‡æˆæœ¬
                costInput.value = (costPrice * shares).toFixed(2);
            }
        };
        
        // ä¿ç•™èˆŠå‡½æ•¸ä»¥å…¼å®¹
        window.calculateCost = window.calculateFromFields;
        window.calculateCostPrice = window.calculateFromFields;

        // æ›´æ–°å–®å€‹è‚¡ç¥¨çš„åƒ¹æ ¼
        async function updateStockPrice(stockId, symbol, region) {
            const info = await fetchStockInfo(symbol, region);
            if (info && info.price) {
                const stockRef = doc(db, 'stocks', stockId);
                await updateDoc(stockRef, {
                    currentPrice: info.price,
                    changePercent: info.changePercent || 0, // åŒæ™‚æ›´æ–°æ¼²è·Œå¹…
                    lastPriceUpdate: new Date().toISOString()
                });
            }
        }

        // ä¸€éµæ›´æ–°æ‰€æœ‰ï¼ˆåŒ¯ç‡+è‚¡åƒ¹ï¼‰
        window.updateAllPricesAndRate = async function() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = 'ğŸ”„ æ›´æ–°ä¸­...<span class="loading-spinner"></span>';
            
            try {
                // å…ˆæ›´æ–°åŒ¯ç‡
                await fetchExchangeRate();
                
                // === å„ªåŒ–ï¼šæŒ‰è‚¡ç¥¨ä»£è™Ÿå»é‡ï¼Œé¿å…é‡è¤‡æŠ“å– ===
                // å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„è‚¡ç¥¨ï¼ˆsymbol + region çµ„åˆï¼‰
                const uniqueStocksMap = new Map();
                stocks.forEach(stock => {
                    const key = `${stock.symbol}_${stock.region}`;
                    if (!uniqueStocksMap.has(key)) {
                        uniqueStocksMap.set(key, {
                            symbol: stock.symbol,
                            region: stock.region,
                            relatedStocks: []
                        });
                    }
                    // è¨˜éŒ„æ‰€æœ‰ç›¸é—œçš„è‚¡ç¥¨ID
                    uniqueStocksMap.get(key).relatedStocks.push(stock.id);
                });
                
                console.log(`ğŸ“Š å…± ${stocks.length} ç­†æ˜ç´°ï¼Œåˆä½µç‚º ${uniqueStocksMap.size} æª”ä¸åŒè‚¡ç¥¨`);
                
                // æ‰¹æ¬¡æ›´æ–°æ‰€æœ‰ä¸é‡è¤‡çš„è‚¡ç¥¨
                let successCount = 0;
                let failCount = 0;
                
                for (const [key, stockInfo] of uniqueStocksMap) {
                    const info = await fetchStockInfo(stockInfo.symbol, stockInfo.region);
                    
                    if (info && info.price) {
                        // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„è‚¡ç¥¨è¨˜éŒ„
                        await Promise.all(
                            stockInfo.relatedStocks.map(stockId => {
                                const stockRef = doc(db, 'stocks', stockId);
                                return updateDoc(stockRef, {
                                    currentPrice: info.price,
                                    changePercent: info.changePercent || 0,
                                    lastPriceUpdate: new Date().toISOString()
                                });
                            })
                        );
                        console.log(`âœ“ ${stockInfo.symbol}: å·²æ›´æ–° ${stockInfo.relatedStocks.length} ç­†è¨˜éŒ„`);
                        successCount++;
                    } else {
                        console.error(`âœ— ${stockInfo.symbol}: æ›´æ–°å¤±æ•—`);
                        failCount++;
                    }
                }
                
                console.log(`âœ… æ›´æ–°å®Œæˆï¼šæˆåŠŸ ${successCount} æª”ï¼Œå¤±æ•— ${failCount} æª”`);
                
            } catch (error) {
                console.error('æ›´æ–°å¤±æ•—:', error);
                alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = 'ğŸ”„ æ›´æ–°';
                updateLastUpdateTime();
            }
        };

        // è‡ªå‹•åˆ·æ–°åŠŸèƒ½
        window.toggleAutoRefresh = function(enabled) {
            if (enabled) {
                autoRefreshInterval = setInterval(() => {
                    updateAllPricesAndRate();
                }, 5 * 60 * 1000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        };

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            document.getElementById('lastUpdate').textContent = `æœ€å¾Œæ›´æ–°: ${timeStr}`;
        }

        // ç¯©é¸åŠŸèƒ½
        window.applyFilters = function() {
            const regionFilter = document.getElementById('filterRegion').value;
            const holderFilter = document.getElementById('filterHolder').value;
            const platformFilter = document.getElementById('filterPlatform').value;
            
            filteredStocks = stocks.filter(stock => {
                if (regionFilter && stock.region !== regionFilter) return false;
                if (holderFilter && stock.holder !== holderFilter) return false;
                if (platformFilter && stock.platform !== platformFilter) return false;
                return true;
            });
            
            renderStocks();
            updateStats();
        };

        window.clearFilters = function() {
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterHolder').value = '';
            document.getElementById('filterPlatform').value = '';
            filteredStocks = [...stocks];
            renderStocks();
            updateStats();
        };

        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        };

        window.logout = async () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                await auth.signOut();
            }
        };

        async function loadStocks() {
            const stocksRef = collection(db, 'stocks');
            onSnapshot(stocksRef, (snapshot) => {
                stocks = [];
                snapshot.forEach((doc) => {
                    stocks.push({ id: doc.id, ...doc.data() });
                });
                filteredStocks = [...stocks];
                renderStocks();
                updateStats();
            });
        }

        // === åˆ†é åˆ‡æ›åŠŸèƒ½ ===
        window.switchTab = function(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é 
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-slate-400');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
            if (tabName === 'overview') {
                document.getElementById('overviewTab').classList.add('active');
                document.getElementById('tabOverview').classList.add('active');
                document.getElementById('tabOverview').classList.remove('text-slate-400');
            } else if (tabName === 'detail') {
                document.getElementById('detailTab').classList.add('active');
                document.getElementById('tabDetail').classList.add('active');
                document.getElementById('tabDetail').classList.remove('text-slate-400');
            }
        };

        // === æ–°å¢ï¼šè¨ˆç®—åˆä½µå¾Œçš„è‚¡ç¥¨çµ±è¨ˆï¼ˆç”¨æ–¼çµ±è¨ˆå€å¡Šï¼‰===
        function getMergedStockStats() {
            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;
            
            // æŒ‰ç…§ symbol + region åˆä½µ
            const merged = {};
            displayStocks.forEach(stock => {
                const key = `${stock.symbol}_${stock.region}`;
                if (!merged[key]) {
                    merged[key] = {
                        symbol: stock.symbol,
                        region: stock.region,
                        companyName: stock.companyName,
                        totalShares: 0,
                        totalCost: 0,
                        currentPrice: stock.currentPrice,
                        changePercent: stock.changePercent || 0 // æ–°å¢æ¼²è·Œå¹…
                    };
                }
                merged[key].totalShares += parseFloat(stock.shares) || 0;
                merged[key].totalCost += parseFloat(stock.investmentCost) || 0;
                // æ›´æ–°æœ€æ–°åƒ¹æ ¼å’Œæ¼²è·Œå¹…
                if (stock.currentPrice) {
                    merged[key].currentPrice = stock.currentPrice;
                }
                if (stock.changePercent !== undefined) {
                    merged[key].changePercent = stock.changePercent;
                }
            });
            
            return Object.values(merged);
        }

        // === æ¸²æŸ“çµ±è¨ˆå€å¡Šï¼ˆç¸½è¦½é ï¼‰===
        function renderSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            
            const mergedStocks = getMergedStockStats();
            
            // è¨ˆç®—ç¸½ç¾å€¼ï¼ˆç”¨æ–¼è¨ˆç®—ä½”æ¯”ï¼‰- æ”¹ç‚ºä»¥å°å¹£è¨ˆç®—
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31.5;
            let totalPortfolioValueTWD = 0;
            mergedStocks.forEach(stock => {
                const currentValue = (parseFloat(stock.currentPrice) || 0) * stock.totalShares;
                const valueTWD = stock.region === 'ç¾è‚¡' ? currentValue * usdRate : currentValue;
                totalPortfolioValueTWD += valueTWD;
            });
            
            // æŒ‰ç…§å°å¹£ç¾å€¼æ’åºï¼ˆç”±å¤§åˆ°å°ï¼‰
            mergedStocks.sort((a, b) => {
                const aValue = (parseFloat(a.currentPrice) || 0) * a.totalShares;
                const bValue = (parseFloat(b.currentPrice) || 0) * b.totalShares;
                const aValueTWD = a.region === 'ç¾è‚¡' ? aValue * usdRate : aValue;
                const bValueTWD = b.region === 'ç¾è‚¡' ? bValue * usdRate : bValue;
                return bValueTWD - aValueTWD;
            });
            
            mergedStocks.forEach(stock => {
                const avgCost = stock.totalShares > 0 ? stock.totalCost / stock.totalShares : 0;
                const currentPrice = Math.abs(parseFloat(stock.currentPrice) || 0);
                const currentValue = currentPrice * stock.totalShares; // åŸå¹£åˆ¥ç¾å€¼
                const valueTWD = stock.region === 'ç¾è‚¡' ? currentValue * usdRate : currentValue; // å°å¹£ç¾å€¼
                const percentage = totalPortfolioValueTWD > 0 ? (valueTWD / totalPortfolioValueTWD * 100) : 0;
                const changePercent = parseFloat(stock.changePercent) || 0;
                
                // æ¼²è·Œå¹…é¡è‰²å’Œç¬¦è™Ÿ
                let changeColor = 'text-slate-400';
                let changeSymbol = '';
                if (changePercent > 0) {
                    changeColor = 'text-green-400';
                    changeSymbol = '+';
                } else if (changePercent < 0) {
                    changeColor = 'text-red-400';
                }
                
                // ç¾åƒ¹é¡è‰²
                let priceColor = 'text-slate-100';
                if (changePercent > 0) {
                    priceColor = 'text-green-400';
                } else if (changePercent < 0) {
                    priceColor = 'text-red-400';
                }
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºå‚µåˆ¸ETFï¼ˆä¸èƒ½åšå¤æ™®å€¼åˆ†æï¼‰
                const isBondETF = stock.symbol && stock.symbol.includes('B') && stock.symbol.startsWith('00');
                
                // å¹£åˆ¥ç¬¦è™Ÿ
                const currencySymbol = stock.region === 'ç¾è‚¡' ? 'USD' : 'TWD';
                
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700 hover:bg-slate-800 transition-colors';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center text-slate-100 font-medium">${stock.region}</td>
                    <td class="px-4 py-3 text-center text-blue-400 font-mono font-bold">${stock.symbol}</td>
                    <td class="px-4 py-3 text-center">
                        ${isBondETF ? 
                            `<span class="text-slate-200">${stock.companyName || stock.symbol}</span>` :
                            `<button class="text-blue-400 hover:text-blue-300 hover:underline cursor-pointer font-medium transition-colors summary-analysis-btn"
                                data-symbol="${stock.symbol}"
                                data-region="${stock.region}"
                                data-company="${stock.companyName || stock.symbol}"
                                data-cost="${stock.totalCost}"
                                data-shares="${stock.totalShares}">
                                ${stock.companyName || stock.symbol}
                            </button>`
                        }
                    </td>
                    <td class="px-4 py-3 text-center text-slate-100 font-mono">${stock.totalShares.toLocaleString()}</td>
                    <td class="px-4 py-3 text-center text-slate-100 font-mono text-xs">${avgCost.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center text-slate-100 font-mono text-xs">${stock.totalCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="px-4 py-3 text-center ${priceColor} font-mono font-semibold">${currentPrice.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center ${changeColor} font-mono font-bold">
                        ${changeSymbol}${changePercent.toFixed(2)}%
                    </td>
                    <td class="px-4 py-3 text-center text-slate-100 font-mono text-xs">
                        <div>${currencySymbol} ${currentValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    </td>
                    <td class="px-4 py-3 text-center text-green-400 font-mono font-bold">
                        TWD ${valueTWD.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <div class="w-24 bg-slate-700 rounded-full h-2.5">
                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-blue-400 font-bold font-mono min-w-[60px] text-right">${percentage.toFixed(1)}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // ç¶å®šç¸½è¦½é çš„åˆ†ææŒ‰éˆ•é»æ“Šäº‹ä»¶
            document.querySelectorAll('.summary-analysis-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    const region = this.dataset.region;
                    const company = this.dataset.company;
                    const cost = parseFloat(this.dataset.cost);
                    const shares = parseFloat(this.dataset.shares);
                    openAnalysisModal(symbol, region, company, cost, shares);
                });
            });
        }

        function renderStocks() {
            const tbody = document.getElementById('stockTableBody');
            const addRow = tbody.querySelector('tr');
            tbody.innerHTML = '';
            tbody.appendChild(addRow);

            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            displayStocks.forEach(stock => {
                // å…ˆé©—è­‰å’Œè½‰æ›æ‰€æœ‰æ•¸å€¼å­—æ®µï¼Œä¸¦ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
                stock.shares = parseFloat(stock.shares) || 0;
                stock.investmentCost = parseFloat(stock.investmentCost) || 0;
                stock.currentPrice = Math.abs(parseFloat(stock.currentPrice) || 0);
                stock.companyName = stock.companyName || '';
                                
                const calc = calculateFields(stock);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700 hover:bg-slate-750';
                
                const lastUpdate = stock.lastPriceUpdate ? new Date(stock.lastPriceUpdate).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'æœªæ›´æ–°';
                
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center text-slate-300">${stock.region || ''}</td>
                    <td class="px-3 py-3 text-center text-slate-200 font-medium">
                        ${stock.companyName || stock.symbol}
                    </td>
                    <td class="px-3 py-3 text-center text-slate-100 font-mono font-semibold">${stock.symbol}</td>
                    <td class="px-3 py-3 text-center text-slate-300 font-mono">${stock.shares.toLocaleString()}</td>
                    <td class="px-3 py-3 text-center text-slate-300 font-mono text-xs">${calc.costPrice.toFixed(2)}</td>
                    <td class="px-3 py-3 text-center text-slate-300 font-mono text-xs">${stock.investmentCost.toLocaleString()}</td>
                    <td class="px-3 py-3 text-center text-slate-300 font-mono text-xs" title="æœ€å¾Œæ›´æ–°: ${lastUpdate}">
                        ${Math.abs(stock.currentPrice).toFixed(2)}
                    </td>
                    <td class="px-3 py-3 text-center text-slate-300 font-mono text-xs">${calc.currentValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="px-3 py-3 text-center font-mono font-semibold ${calc.returnRate >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${calc.returnRate >= 0 ? '+' : ''}${calc.returnRate.toFixed(2)}%
                    </td>
                    <td class="px-3 py-3 text-center text-slate-300">${stock.holder}</td>
                    <td class="px-3 py-3 text-center text-slate-300">${stock.platform}</td>
                    <td class="px-3 py-3 text-center no-print">
                        <div class="flex gap-2 justify-center">
                            <button onclick="deleteStock('${stock.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 rounded hover:bg-red-900 hover:bg-opacity-20 transition-colors" title="åˆªé™¤ï¼ˆå»ºæª”éŒ¯èª¤ï¼‰">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                            <button onclick="openSellModal('${stock.id}', '${stock.symbol}', '${stock.companyName || stock.symbol}', ${stock.shares})" class="text-green-400 hover:text-green-300 px-2 py-1 rounded hover:bg-green-900 hover:bg-opacity-20 transition-colors" title="è³£å‡ºéƒ¨åˆ†è‚¡æ•¸">
                                ğŸ’° è³£å‡º
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // åŒæ™‚æ›´æ–°çµ±è¨ˆå€å¡Š
            renderSummaryTable();
        }

        function calculateFields(stock) {
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31.5;
            const shares = parseFloat(stock.shares) || 0;
            const investmentCost = parseFloat(stock.investmentCost) || 0;
            const currentPrice = Math.abs(parseFloat(stock.currentPrice) || 0); // ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
            
            const costPrice = shares > 0 ? investmentCost / shares : 0;
            const currentValue = currentPrice * shares;
            const returnRate = investmentCost > 0 ? ((currentValue - investmentCost) / investmentCost) * 100 : 0;
            
            const currentValueTWD = stock.region === 'ç¾è‚¡' ? currentValue * usdRate : currentValue;
            const investmentCostTWD = stock.region === 'ç¾è‚¡' ? investmentCost * usdRate : investmentCost;
            
            return { costPrice, currentPrice, currentValue, currentValueTWD, investmentCostTWD, returnRate };
        }

        window.updateStats = function() {
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31.5;
            let totalCost = 0, totalValue = 0;

            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            displayStocks.forEach(stock => {
                const calc = calculateFields(stock);
                totalCost += calc.investmentCostTWD;
                totalValue += calc.currentValueTWD;
            });

            const profit = totalValue - totalCost;
            const returnRate = totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0;

            document.getElementById('totalCost').textContent = 'TWD ' + totalCost.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalValue').textContent = 'TWD ' + totalValue.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalProfit').textContent = 'TWD ' + profit.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalProfit').className = 'text-2xl font-bold ' + (profit >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('totalReturn').textContent = (returnRate >= 0 ? '+' : '') + returnRate.toFixed(2) + '%';
            document.getElementById('totalReturn').className = 'text-2xl font-bold ' + (returnRate >= 0 ? 'text-green-400' : 'text-red-400');
        }

        window.addStock = async () => {
            const region = document.getElementById('newRegion').value;
            const companyName = document.getElementById('newCompany').value;
            const symbol = document.getElementById('newSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('newShares').value);
            const costPrice = parseFloat(document.getElementById('newCostPrice').value);
            const investmentCost = parseFloat(document.getElementById('newCost').value);
            const holder = document.getElementById('newHolder').value;
            const platform = document.getElementById('newPlatform').value;

            if (!symbol || !shares || !holder) {
                alert('è«‹å¡«å¯«è‚¡ç¥¨ä»£è™Ÿã€è‚¡æ•¸å’ŒæŒæœ‰äºº');
                return;
            }

            if (!costPrice && !investmentCost) {
                alert('è«‹å¡«å¯«æˆæœ¬åƒ¹æˆ–æŠ•è³‡æˆæœ¬');
                return;
            }

            // è¨ˆç®—ç¼ºå°‘çš„å€¼
            let finalCostPrice = costPrice;
            let finalInvestmentCost = investmentCost;
            
            if (!finalCostPrice && finalInvestmentCost) {
                finalCostPrice = finalInvestmentCost / shares;
            } else if (finalCostPrice && !finalInvestmentCost) {
                finalInvestmentCost = finalCostPrice * shares;
            }

            // é¡¯ç¤ºè¼‰å…¥æç¤º
            const addButton = event.target;
            const originalText = addButton.innerHTML;
            addButton.disabled = true;
            addButton.innerHTML = 'â³ ç²å–è‚¡åƒ¹ä¸­...';

            // è‡ªå‹•ç²å–ç•¶å‰åƒ¹æ ¼å’Œå…¬å¸åç¨±ï¼ˆæœƒè‡ªå‹•é‡è©¦3æ¬¡ï¼‰
            const info = await fetchStockInfo(symbol, region);
            
            if (!info || !info.price) {
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                alert(`âŒ ç„¡æ³•ç²å– ${symbol} çš„è‚¡åƒ¹\n\nå¯èƒ½åŸå› ï¼š\n1. è‚¡ç¥¨ä»£è™Ÿä¸æ­£ç¢º\n2. è©²è‚¡ç¥¨å·²ä¸‹å¸‚æˆ–åœç‰Œ\n3. ç¶²è·¯é€£ç·šå•é¡Œ\n\nç³»çµ±å·²è‡ªå‹•é‡è©¦ 3 æ¬¡ï¼Œè«‹æª¢æŸ¥å¾Œå†è©¦ã€‚`);
                return;
            }

            const finalCompanyName = companyName || info.companyName;

            try {
                addButton.innerHTML = 'â³ å„²å­˜ä¸­...';
                
                await addDoc(collection(db, 'stocks'), {
                    region, 
                    companyName: finalCompanyName, 
                    symbol, 
                    shares, 
                    investmentCost: finalInvestmentCost, 
                    currentPrice: Math.abs(info.price),
                    changePercent: info.changePercent || 0, // å„²å­˜æ¼²è·Œå¹…
                    holder, 
                    platform,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email,
                    lastPriceUpdate: new Date().toISOString()
                });

                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('newCompany').value = '';
                document.getElementById('newSymbol').value = '';
                document.getElementById('newShares').value = '';
                document.getElementById('newCostPrice').value = '';
                document.getElementById('newCost').value = '';
                document.getElementById('newHolder').value = '';
                
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                
                // é¡¯ç¤ºæˆåŠŸæç¤º
                alert(`âœ… æ–°å¢æˆåŠŸï¼\n\n${finalCompanyName} (${symbol})\nè‚¡æ•¸: ${shares}\nç¾åƒ¹: ${Math.abs(info.price).toFixed(2)}`);
                
            } catch (error) {
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        };

        // === è¡¨æ ¼æ’åºåŠŸèƒ½ ===
        let sortConfig = { key: null, direction: 'asc' };
        
        window.sortTable = function(key) {
            // åˆ‡æ›æ’åºæ–¹å‘
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.sort-indicator').forEach(el => {
                el.textContent = 'â†•';
                el.classList.remove('text-blue-400');
            });
            
            const indicator = document.getElementById(`sort-${key}`);
            if (indicator) {
                indicator.textContent = sortConfig.direction === 'asc' ? 'â†‘' : 'â†“';
                indicator.classList.add('text-blue-400');
            }
            
            // å–å¾—è¦æ’åºçš„è³‡æ–™
            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;
            
            // æ’åº
            const sortedStocks = [...displayStocks].sort((a, b) => {
                let aVal, bVal;
                
                switch(key) {
                    case 'costPrice':
                        aVal = a.shares > 0 ? a.investmentCost / a.shares : 0;
                        bVal = b.shares > 0 ? b.investmentCost / b.shares : 0;
                        break;
                    case 'currentValue':
                        aVal = (parseFloat(a.currentPrice) || 0) * (parseFloat(a.shares) || 0);
                        bVal = (parseFloat(b.currentPrice) || 0) * (parseFloat(b.shares) || 0);
                        break;
                    case 'returnRate':
                        const aCost = a.shares > 0 ? a.investmentCost / a.shares : 0;
                        const bCost = b.shares > 0 ? b.investmentCost / b.shares : 0;
                        aVal = aCost > 0 ? ((parseFloat(a.currentPrice) - aCost) / aCost) * 100 : 0;
                        bVal = bCost > 0 ? ((parseFloat(b.currentPrice) - bCost) / bCost) * 100 : 0;
                        break;
                    case 'shares':
                    case 'investmentCost':
                    case 'currentPrice':
                        aVal = parseFloat(a[key]) || 0;
                        bVal = parseFloat(b[key]) || 0;
                        break;
                    default:
                        aVal = (a[key] || '').toString().toLowerCase();
                        bVal = (b[key] || '').toString().toLowerCase();
                }
                
                if (typeof aVal === 'number') {
                    return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    if (sortConfig.direction === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                }
            });
            
            // æ›´æ–° filteredStocks ä¸¦é‡æ–°æ¸²æŸ“
            if (filteredStocks.length > 0 || 
                document.getElementById('filterRegion').value || 
                document.getElementById('filterHolder').value || 
                document.getElementById('filterPlatform').value) {
                filteredStocks = sortedStocks;
            } else {
                stocks = sortedStocks;
            }
            
            renderStocks();
        };

        // === è³£å‡ºåŠŸèƒ½ ===
        let currentSellStockId = null;
        let currentSellMaxShares = 0;
        
        window.openSellModal = function(stockId, symbol, companyName, currentShares) {
            currentSellStockId = stockId;
            currentSellMaxShares = currentShares;
            
            document.getElementById('sellStockInfo').textContent = `${companyName} (${symbol})`;
            document.getElementById('sellCurrentShares').textContent = `${currentShares.toLocaleString()} è‚¡`;
            document.getElementById('sellShares').value = '';
            document.getElementById('sellShares').max = currentShares;
            
            document.getElementById('sellModal').style.display = 'flex';
        };
        
        window.closeSellModal = function() {
            document.getElementById('sellModal').style.display = 'none';
            currentSellStockId = null;
            currentSellMaxShares = 0;
        };
        
        window.confirmSell = async function() {
            const sellShares = parseFloat(document.getElementById('sellShares').value);
            
            if (!sellShares || sellShares <= 0) {
                alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„è³£å‡ºè‚¡æ•¸');
                return;
            }
            
            if (sellShares > currentSellMaxShares) {
                alert(`âŒ è³£å‡ºè‚¡æ•¸ä¸èƒ½è¶…éæŒæœ‰è‚¡æ•¸ ${currentSellMaxShares}`);
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦è³£å‡º ${sellShares} è‚¡å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                // æ‰¾åˆ°è©²è‚¡ç¥¨è¨˜éŒ„
                const stock = stocks.find(s => s.id === currentSellStockId);
                if (!stock) {
                    alert('âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨è¨˜éŒ„');
                    return;
                }
                
                const newShares = stock.shares - sellShares;
                
                if (newShares <= 0) {
                    // å…¨éƒ¨è³£å‡ºï¼Œç›´æ¥åˆªé™¤è¨˜éŒ„
                    await deleteDoc(doc(db, 'stocks', currentSellStockId));
                    alert(`âœ… å·²å…¨éƒ¨è³£å‡ºä¸¦åˆªé™¤è¨˜éŒ„`);
                } else {
                    // éƒ¨åˆ†è³£å‡ºï¼Œæ›´æ–°è¨˜éŒ„
                    // è¨ˆç®—æ–°çš„æŠ•è³‡æˆæœ¬ï¼ˆæŒ‰æ¯”ä¾‹æ¸›å°‘ï¼‰
                    const costPerShare = stock.investmentCost / stock.shares;
                    const newInvestmentCost = costPerShare * newShares;
                    
                    const stockRef = doc(db, 'stocks', currentSellStockId);
                    await updateDoc(stockRef, {
                        shares: newShares,
                        investmentCost: newInvestmentCost
                    });
                    
                    alert(`âœ… è³£å‡ºæˆåŠŸï¼\n\nå‰©é¤˜è‚¡æ•¸: ${newShares.toLocaleString()}\nå‰©é¤˜æˆæœ¬: ${newInvestmentCost.toLocaleString()}`);
                }
                
                closeSellModal();
            } catch (error) {
                console.error('è³£å‡ºå¤±æ•—:', error);
                alert('âŒ è³£å‡ºå¤±æ•—ï¼š' + error.message);
            }
        };

        window.deleteStock = async (id) => {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, 'stocks', id));
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        };

        window.updateStockPrice = updateStockPrice;

        window.exportToExcel = () => {
            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            const data = displayStocks.map(stock => {
                const calc = calculateFields(stock);
                return {
                    åœ°å€: stock.region,
                    å…¬å¸åç¨±: stock.companyName || stock.symbol,
                    è‚¡ç¥¨ä»£è™Ÿ: stock.symbol,
                    è‚¡æ•¸: stock.shares,
                    æˆæœ¬è‚¡åƒ¹: calc.costPrice.toFixed(2),
                    æŠ•è³‡æˆæœ¬: stock.investmentCost,
                    ç¾åƒ¹: Math.abs(stock.currentPrice).toFixed(2),
                    ç¾å€¼: calc.currentValue.toFixed(2),
                    å ±é…¬ç‡: calc.returnRate.toFixed(2) + '%',
                    æŒæœ‰äºº: stock.holder,
                    æŒæœ‰å¹³å°: stock.platform,
                    æœ€å¾Œæ›´æ–°: stock.lastPriceUpdate || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æŠ•è³‡çµ„åˆ');
            XLSX.writeFile(wb, `æŠ•è³‡çµ„åˆ_${new Date().toISOString().split('T')[0]}.xlsx`);
        };
        
        // === æ‰‹æ©Ÿç«¯è¡¨å–®å‡½æ•¸ ===
        
        // æ‰“é–‹æ‰‹æ©Ÿç«¯è¡¨å–®
        window.openMobileForm = function() {
            document.getElementById('mobileFormOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        };
        
        // é—œé–‰æ‰‹æ©Ÿç«¯è¡¨å–®
        window.closeMobileForm = function(event) {
            // å¦‚æœæœ‰eventä¸”é»æ“Šçš„æ˜¯overlayæœ¬èº«ï¼ˆä¸æ˜¯containerå…§éƒ¨ï¼‰ï¼Œæ‰é—œé–‰
            if (!event || event.target.id === 'mobileFormOverlay') {
                document.getElementById('mobileFormOverlay').style.display = 'none';
                document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
                // æ¸…ç©ºè¡¨å–®
                clearMobileForm();
            }
        };
        
        // æ¸…ç©ºæ‰‹æ©Ÿç«¯è¡¨å–®
        function clearMobileForm() {
            document.getElementById('mobileSymbol').value = '';
            document.getElementById('mobileCompany').value = '';
            document.getElementById('mobileShares').value = '';
            document.getElementById('mobileCostPrice').value = '';
            document.getElementById('mobileCost').value = '';
            document.getElementById('mobileHolder').value = '';
        }
        
        // æ‰‹æ©Ÿç«¯ç²å–å…¬å¸åç¨±
        window.fetchCompanyNameMobile = async function() {
            const symbolInput = document.getElementById('mobileSymbol');
            const regionSelect = document.getElementById('mobileRegion');
            const companyInput = document.getElementById('mobileCompany');
            
            let symbol = symbolInput.value.toUpperCase().trim();
            
            if (!symbol) return;
            
            // è‡ªå‹•åˆ¤æ–·åœ°å€
            if (/^\d/.test(symbol)) {
                regionSelect.value = 'å°è‚¡';
            } else if (/^[A-Z]/.test(symbol)) {
                regionSelect.value = 'ç¾è‚¡';
            }
            
            const region = regionSelect.value;
            
            companyInput.value = 'æ­£åœ¨ç²å–...';
            
            const info = await fetchStockInfo(symbol, region);
            if (info) {
                companyInput.value = info.companyName;
            } else {
                companyInput.value = '';
                alert(`âŒ ç„¡æ³•ç²å– ${symbol} çš„è³‡è¨Š\n\nå¯èƒ½åŸå› ï¼š\n1. è‚¡ç¥¨ä»£è™Ÿä¸æ­£ç¢º\n2. è©²è‚¡ç¥¨å·²ä¸‹å¸‚\n3. ç¶²è·¯é€£ç·šå•é¡Œ\n\nç³»çµ±å·²è‡ªå‹•é‡è©¦ 3 æ¬¡ã€‚`);
            }
        };
        
        // æ‰‹æ©Ÿç«¯æ™ºèƒ½è¨ˆç®—å‡½æ•¸
        window.calculateCostMobile = function() {
            const costPriceInput = document.getElementById('mobileCostPrice');
            const sharesInput = document.getElementById('mobileShares');
            const costInput = document.getElementById('mobileCost');
            
            const costPrice = parseFloat(costPriceInput.value) || 0;
            const shares = parseFloat(sharesInput.value) || 0;
            const cost = parseFloat(costInput.value) || 0;
            
            // ä»»æ„å…©å€‹æœ‰å€¼ï¼Œè¨ˆç®—ç¬¬ä¸‰å€‹
            if (costPrice && shares && !cost) {
                costInput.value = (costPrice * shares).toFixed(2);
            } else if (costPrice && cost && !shares) {
                sharesInput.value = Math.floor(cost / costPrice);
            } else if (shares && cost && !costPrice) {
                costPriceInput.value = (cost / shares).toFixed(2);
            } else if (costPrice && shares && cost) {
                costInput.value = (costPrice * shares).toFixed(2);
            }
        };
        
        // ä¿ç•™å…¼å®¹
        window.calculateCostPriceMobile = window.calculateCostMobile;
        
        // æ‰‹æ©Ÿç«¯æ–°å¢è‚¡ç¥¨
        window.addStockMobile = async function() {
            const region = document.getElementById('mobileRegion').value;
            const companyName = document.getElementById('mobileCompany').value;
            const symbol = document.getElementById('mobileSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('mobileShares').value);
            const costPrice = parseFloat(document.getElementById('mobileCostPrice').value);
            const investmentCost = parseFloat(document.getElementById('mobileCost').value);
            const holder = document.getElementById('mobileHolder').value;
            const platform = document.getElementById('mobilePlatform').value;

            if (!symbol || !shares || !holder) {
                alert('è«‹å¡«å¯«è‚¡ç¥¨ä»£è™Ÿã€è‚¡æ•¸å’ŒæŒæœ‰äºº');
                return;
            }

            if (!costPrice && !investmentCost) {
                alert('è«‹å¡«å¯«æˆæœ¬åƒ¹æˆ–æŠ•è³‡æˆæœ¬');
                return;
            }

            // è¨ˆç®—ç¼ºå°‘çš„å€¼
            let finalCostPrice = costPrice;
            let finalInvestmentCost = investmentCost;
            
            if (!finalCostPrice && finalInvestmentCost) {
                finalCostPrice = finalInvestmentCost / shares;
            } else if (finalCostPrice && !finalInvestmentCost) {
                finalInvestmentCost = finalCostPrice * shares;
            }

            // é¡¯ç¤ºè¼‰å…¥æç¤º
            const addButton = event.target;
            const originalText = addButton.innerHTML;
            addButton.disabled = true;
            addButton.innerHTML = 'â³ ç²å–è‚¡åƒ¹ä¸­...';

            // è‡ªå‹•ç²å–ç•¶å‰åƒ¹æ ¼å’Œå…¬å¸åç¨±ï¼ˆæœƒè‡ªå‹•é‡è©¦3æ¬¡ï¼‰
            const info = await fetchStockInfo(symbol, region);
            
            if (!info || !info.price) {
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                alert(`âŒ ç„¡æ³•ç²å– ${symbol} çš„è‚¡åƒ¹\n\nç³»çµ±å·²è‡ªå‹•é‡è©¦ 3 æ¬¡\nè«‹æª¢æŸ¥è‚¡ç¥¨ä»£è™Ÿå¾Œå†è©¦`);
                return;
            }

            const finalCompanyName = companyName || info.companyName;

            try {
                addButton.innerHTML = 'â³ å„²å­˜ä¸­...';
                
                await addDoc(collection(db, 'stocks'), {
                    region, 
                    companyName: finalCompanyName, 
                    symbol, 
                    shares, 
                    investmentCost: finalInvestmentCost, 
                    currentPrice: Math.abs(info.price),
                    changePercent: info.changePercent || 0, // å„²å­˜æ¼²è·Œå¹…
                    holder, 
                    platform,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email,
                    lastPriceUpdate: new Date().toISOString()
                });

                // é—œé–‰è¡¨å–®ä¸¦æ¸…ç©º
                closeMobileForm();
                
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                
                alert(`âœ… æ–°å¢æˆåŠŸï¼\n\n${finalCompanyName} (${symbol})\nè‚¡æ•¸: ${shares}\nç¾åƒ¹: ${Math.abs(info.price).toFixed(2)}`);
            } catch (error) {
                addButton.disabled = false;
                addButton.innerHTML = originalText;
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        };
        
        // === åˆ†ææ¨¡æ…‹æ¡†åŠŸèƒ½ ===
        
        // æ‰“é–‹åˆ†ææ¨¡æ…‹æ¡†
        window.openAnalysisModal = async function(symbol, region, companyName, investmentCost, shares) {
            const modal = document.getElementById('analysisModal');
            const content = document.getElementById('analysisContent');
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-slate-100">${companyName} (${symbol})</h2>
                        <button onclick="closeAnalysisModal()" class="text-slate-400 hover:text-slate-200 text-3xl">&times;</button>
                    </div>
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400 mx-auto mb-4"></div>
                        <p class="text-slate-400">æ­£åœ¨ç²å–åˆ†ææ•¸æ“š...</p>
                    </div>
                </div>
            `;
            
            try {
                // è¨ˆç®—è³¼è²·æ—¥æœŸï¼ˆä¼°ç®—ï¼‰
                const estimatedBuyDate = new Date();
                estimatedBuyDate.setFullYear(estimatedBuyDate.getFullYear() - 1); // å‡è¨­æŒæœ‰1å¹´
                
                // åŒæ™‚ç²å– 3å¹´ã€5å¹´ã€10å¹´ æ•¸æ“š
                const [data3y, data5y, data10y] = await Promise.all([
                    fetchAnalysisData(symbol, region, '3y'),
                    fetchAnalysisData(symbol, region, '5y'),
                    fetchAnalysisData(symbol, region, '10y')
                ]);
                
                // é¡¯ç¤ºåˆ†æçµæœ
                displayAnalysisResults(symbol, region, companyName, investmentCost, shares, {
                    '3y': data3y,
                    '5y': data5y,
                    '10y': data10y
                });
                
            } catch (error) {
                content.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-slate-100">${companyName} (${symbol})</h2>
                            <button onclick="closeAnalysisModal()" class="text-slate-400 hover:text-slate-200 text-3xl">&times;</button>
                        </div>
                        <div class="text-center py-12">
                            <p class="text-red-400 text-lg">âŒ ç„¡æ³•ç²å–åˆ†ææ•¸æ“š</p>
                            <p class="text-slate-400 mt-2">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        };
        
        // é—œé–‰åˆ†ææ¨¡æ…‹æ¡†
        window.closeAnalysisModal = function() {
            const modal = document.getElementById('analysisModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        };
        
        // ç²å–åˆ†ææ•¸æ“š
        async function fetchAnalysisData(symbol, region, range) {
            let apiSymbol = symbol;
            if (region === 'å°è‚¡') {
                // å‚µåˆ¸ ETF ä½¿ç”¨ .TWOï¼Œä¸€èˆ¬å°è‚¡ä½¿ç”¨ .TW
                if (symbol.startsWith('00') && symbol.includes('B')) {
                    apiSymbol = symbol + '.TWO';
                } else {
                    apiSymbol = symbol + '.TW';
                }
            }
            
            const corsProxy = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${apiSymbol}?interval=1d&range=${range}`;
            const url = corsProxy + encodeURIComponent(apiUrl);
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                throw new Error('ç„¡æ³•ç²å–æ•¸æ“š');
            }
            
            const result = data.chart.result[0];
            const timestamps = result.timestamp;
            const closes = result.indicators.quote[0].close.filter(v => v !== null);
            
            // è¨ˆç®—æ—¥å ±é…¬ç‡
            const returns = [];
            for (let i = 1; i < closes.length; i++) {
                const dailyReturn = (closes[i] - closes[i-1]) / closes[i-1];
                returns.push(dailyReturn);
            }
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const avgDailyReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const annualizedReturn = Math.pow(1 + avgDailyReturn, 252) - 1;
            
            // è¨ˆç®—æ¨™æº–å·®
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgDailyReturn, 2), 0) / returns.length;
            const dailyStdDev = Math.sqrt(variance);
            const annualizedStdDev = dailyStdDev * Math.sqrt(252);
            
            // è¨ˆç®—å¤æ™®å€¼ï¼ˆå‡è¨­ç„¡é¢¨éšªåˆ©ç‡ç‚º 1.5% å°è‚¡ï¼Œ4.5% ç¾è‚¡ï¼‰
            const riskFreeRate = region === 'ç¾è‚¡' ? 0.045 : 0.015;
            const excessReturn = annualizedReturn - riskFreeRate;
            const sharpeRatio = excessReturn / annualizedStdDev;
            
            // è¨ˆç®—æœ€å¤§å›æ’¤
            let maxDrawdown = 0;
            let peak = closes[0];
            for (let price of closes) {
                if (price > peak) peak = price;
                const drawdown = (peak - price) / peak;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            }
            
            // è¨ˆç®—ç¸½å ±é…¬
            const totalReturn = (closes[closes.length - 1] - closes[0]) / closes[0];
            
            return {
                totalReturn,
                annualizedReturn,
                annualizedStdDev,
                sharpeRatio,
                maxDrawdown,
                tradingDays: closes.length,
                riskFreeRate
            };
        }
        
        // é¡¯ç¤ºåˆ†æçµæœ
        function displayAnalysisResults(symbol, region, companyName, investmentCost, shares, dataByPeriod) {
            const content = document.getElementById('analysisContent');
            
            // åˆ¤æ–·å¤æ™®å€¼ç­‰ç´šçš„å‡½æ•¸
            const getSharpeGrade = (sharpe) => {
                if (sharpe < 0) return { grade: 'å¾ˆå·®', color: 'text-red-400', icon: 'ğŸ”´' };
                if (sharpe < 1) return { grade: 'æ™®é€š', color: 'text-yellow-400', icon: 'ğŸŸ¡' };
                if (sharpe < 2) return { grade: 'è‰¯å¥½', color: 'text-green-400', icon: 'ğŸŸ¢' };
                if (sharpe < 3) return { grade: 'å„ªç§€', color: 'text-blue-400', icon: 'ğŸ”µ' };
                return { grade: 'å“è¶Š', color: 'text-purple-400', icon: 'ğŸŸ£' };
            };
            
            content.innerHTML = `
                <div class="p-6">
                    <!-- æ¨™é¡Œ -->
                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-blue-500">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-100 mb-1">${companyName}</h2>
                            <p class="text-slate-400">
                                <span class="font-mono text-blue-400">${symbol}</span> 
                                <span class="mx-2">|</span> 
                                <span>${region}</span>
                            </p>
                        </div>
                        <button onclick="closeAnalysisModal()" class="text-slate-400 hover:text-slate-200 text-3xl leading-none">&times;</button>
                    </div>
                    
                    <!-- å¤æ™®å€¼æ¯”è¼ƒ -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                            <span>ğŸ“Š</span>
                            <span>å¤æ™®å€¼åˆ†æï¼ˆSharpe Ratioï¼‰</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${['3y', '5y', '10y'].map(period => {
                                const data = dataByPeriod[period];
                                if (!data) return '<div class="bg-slate-700 rounded-lg p-4 text-center text-slate-500">æ•¸æ“šä¸è¶³</div>';
                                const sharpeGrade = getSharpeGrade(data.sharpeRatio);
                                return `
                                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg p-4 border-2 ${sharpeGrade.color.replace('text-', 'border-')}">
                                        <div class="text-center mb-3">
                                            <div class="text-sm text-slate-400 mb-1">${period === '3y' ? '3 å¹´' : period === '5y' ? '5 å¹´' : '10 å¹´'}æœŸ</div>
                                            <div class="text-4xl font-bold ${sharpeGrade.color} mb-1">${data.sharpeRatio.toFixed(3)}</div>
                                            <div class="text-sm ${sharpeGrade.color} font-semibold flex items-center justify-center gap-1">
                                                <span>${sharpeGrade.icon}</span>
                                                <span>${sharpeGrade.grade}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-1 text-xs text-slate-300 border-t border-slate-600 pt-3">
                                            <div class="flex justify-between">
                                                <span>å¹´åŒ–å ±é…¬</span>
                                                <span class="${data.annualizedReturn >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">
                                                    ${(data.annualizedReturn * 100).toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>å¹´åŒ–æ³¢å‹•</span>
                                                <span class="text-yellow-400">${(data.annualizedStdDev * 100).toFixed(2)}%</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>æœ€å¤§å›æ’¤</span>
                                                <span class="text-red-400">${(data.maxDrawdown * 100).toFixed(2)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- è©³ç´°æŒ‡æ¨™ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- å ±é…¬ç‡åˆ†æ -->
                        <div class="bg-slate-700 rounded-lg p-4">
                            <h4 class="font-bold text-slate-100 mb-3 flex items-center gap-2">
                                <span>ğŸ“ˆ</span>
                                <span>å ±é…¬ç‡æ¯”è¼ƒ</span>
                            </h4>
                            <div class="space-y-3">
                                ${['3y', '5y', '10y'].map(period => {
                                    const data = dataByPeriod[period];
                                    if (!data) return '';
                                    return `
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-slate-400">${period === '3y' ? '3 å¹´' : period === '5y' ? '5 å¹´' : '10 å¹´'}</span>
                                                <span class="${data.totalReturn >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">
                                                    ${data.totalReturn >= 0 ? '+' : ''}${(data.totalReturn * 100).toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="flex justify-between text-xs text-slate-400">
                                                <span>å¹´åŒ–</span>
                                                <span class="${data.annualizedReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
                                                    ${(data.annualizedReturn * 100).toFixed(2)}%
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- é¢¨éšªæŒ‡æ¨™ -->
                        <div class="bg-slate-700 rounded-lg p-4">
                            <h4 class="font-bold text-slate-100 mb-3 flex items-center gap-2">
                                <span>âš ï¸</span>
                                <span>é¢¨éšªæŒ‡æ¨™æ¯”è¼ƒ</span>
                            </h4>
                            <div class="space-y-3">
                                ${['3y', '5y', '10y'].map(period => {
                                    const data = dataByPeriod[period];
                                    if (!data) return '';
                                    return `
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-slate-400">${period === '3y' ? '3 å¹´' : period === '5y' ? '5 å¹´' : '10 å¹´'}</span>
                                                <span class="text-yellow-400 font-bold">${(data.annualizedStdDev * 100).toFixed(2)}%</span>
                                            </div>
                                            <div class="flex justify-between text-xs text-slate-400">
                                                <span>æœ€å¤§å›æ’¤</span>
                                                <span class="text-red-400">${(data.maxDrawdown * 100).toFixed(2)}%</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- æŠ•è³‡å»ºè­° -->
                    <div class="mt-6 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg p-4">
                        <h4 class="font-bold text-blue-300 mb-2 flex items-center gap-2">
                            <span>ğŸ’¡</span>
                            <span>é—œæ–¼å¤æ™®å€¼</span>
                        </h4>
                        <div class="text-sm text-slate-300 space-y-1">
                            <p><strong>å¤æ™®å€¼</strong> = (å¹´åŒ–å ±é…¬ç‡ - ç„¡é¢¨éšªåˆ©ç‡) / å¹´åŒ–æ³¢å‹•ç‡</p>
                            <p>æ•¸å€¼è¶Šé«˜ï¼Œä»£è¡¨æ¯æ‰¿æ“”ä¸€å–®ä½é¢¨éšªæ‰€ç²å¾—çš„è¶…é¡å ±é…¬è¶Šå¤šã€‚</p>
                            <p class="text-xs text-slate-400 mt-2">
                                è¨»ï¼šæœ¬åˆ†æåŸºæ–¼æ­·å²æ•¸æ“šï¼Œéå»è¡¨ç¾ä¸ä»£è¡¨æœªä¾†çµæœã€‚æŠ•è³‡å‰è«‹å¯©æ…è©•ä¼°ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
    
    <!-- åˆ†ææ¨¡æ…‹æ¡† HTML -->
    <div id="analysisModal" class="analysis-modal" style="display: none;" onclick="if(event.target.id==='analysisModal') closeAnalysisModal()">
        <div id="analysisContent" class="analysis-content bg-slate-800 border-2 border-blue-500 rounded-lg max-w-5xl w-full mx-4" onclick="event.stopPropagation()">
            <!-- å…§å®¹æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
        </div>
    </div>
    
    <!-- è³£å‡ºæ¨¡æ…‹æ¡† HTML -->
    <div id="sellModal" class="analysis-modal" style="display: none;" onclick="if(event.target.id==='sellModal') closeSellModal()">
        <div class="bg-slate-800 border-2 border-green-500 rounded-lg max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-green-400">ğŸ’° è³£å‡ºè‚¡ç¥¨</h3>
                <button onclick="closeSellModal()" class="text-slate-400 hover:text-slate-200 text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-300 mb-1">è‚¡ç¥¨</label>
                    <div id="sellStockInfo" class="text-lg font-semibold text-slate-100"></div>
                </div>
                
                <div>
                    <label class="block text-sm text-slate-300 mb-1">ç›®å‰æŒæœ‰è‚¡æ•¸</label>
                    <div id="sellCurrentShares" class="text-lg font-bold text-blue-400"></div>
                </div>
                
                <div>
                    <label for="sellShares" class="block text-sm text-slate-300 mb-1">è³£å‡ºè‚¡æ•¸</label>
                    <input type="number" id="sellShares" min="1" 
                           class="w-full bg-slate-700 text-slate-100 px-4 py-2 rounded border border-slate-600 text-lg font-mono"
                           placeholder="è¼¸å…¥è¦è³£å‡ºçš„è‚¡æ•¸" />
                    <div class="text-xs text-slate-400 mt-1">
                        ğŸ’¡ æç¤ºï¼šè³£å‡ºå¾Œç³»çµ±æœƒè‡ªå‹•é‡æ–°è¨ˆç®—æŠ•è³‡æˆæœ¬å’Œå…¶ä»–æ¬„ä½
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="confirmSell()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        ç¢ºèªè³£å‡º
                    </button>
                    <button onclick="closeSellModal()" 
                            class="flex-1 bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
