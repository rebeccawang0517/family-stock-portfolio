<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAt8QWDrmdYxnIsjEWX6DJ5tHXnDPDSwdM",
            authDomain: "rebecca-financial-platform.firebaseapp.com",
            projectId: "rebecca-financial-platform",
            storageBucket: "rebecca-financial-platform.firebasestorage.app",
            messagingSenderId: "335938745651",
            appId: "1:335938745651:web:2c090e33a72db1a5adfa46"
        };

        const allowedEmails = [
            'rebeccawang0517@gmail.com',
            'sclu.eric@gmail.com'
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        window.firebaseApp = { auth, db, provider, allowedEmails };
    </script>

    <style>
        @media print {
            .no-print { display: none !important; }
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-slate-100 mb-2 text-center">å®¶æ—è‚¡ç¥¨ç®¡ç†ç³»çµ±</h1>
            <p class="text-slate-400 text-center mb-8">Professional Portfolio Management</p>
            
            <div class="space-y-4">
                <button onclick="loginWithGoogle()" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                
                <p class="text-sm text-slate-400 text-center">åƒ…é™ Rebeccaã€Eric ä½¿ç”¨</p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-2xl p-6 mb-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-100 mb-2">å®¶æ—è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</h1>
                        <p class="text-slate-400">å·²ç™»å…¥ï¼š<span id="userEmail" class="text-blue-400"></span></p>
                    </div>
                    
                    <div class="flex items-center gap-3 flex-wrap no-print">
                        <button onclick="updateAllPricesAndRate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ”„ ä¸€éµå…¨éƒ¨æ›´æ–°
                        </button>
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“¥ åŒ¯å‡º Excel
                        </button>
                        <button onclick="window.print()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ–¨ï¸ åˆ—å°
                        </button>
                        <button onclick="logout()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-4 mb-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-slate-300 font-medium">åŒ¯ç‡ USD/TWD</span>
                        <input type="number" id="usdRate" value="31.5" step="0.01" class="bg-slate-700 text-slate-100 px-3 py-1 rounded border border-slate-600 focus:border-blue-500 focus:outline-none w-24 text-right font-mono" onchange="updateStats()" />
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-slate-300">
                            <input type="checkbox" id="autoRefresh" class="rounded" checked onchange="toggleAutoRefresh(this.checked)">
                            <span>è‡ªå‹•æ›´æ–° (æ¯5åˆ†é˜)</span>
                        </label>
                        <span id="lastUpdate" class="text-slate-500 text-sm"></span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="text-slate-400 text-sm mb-1">ç¸½æŠ•è³‡æˆæœ¬</div>
                    <div id="totalCost" class="text-2xl font-bold text-slate-100">TWD 0</div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="text-slate-400 text-sm mb-1">ç¸½å¸‚å€¼</div>
                    <div id="totalValue" class="text-2xl font-bold text-slate-100">TWD 0</div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="text-slate-400 text-sm mb-1">ç¸½æç›Š</div>
                    <div id="totalProfit" class="text-2xl font-bold">TWD 0</div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                    <div class="text-slate-400 text-sm mb-1">ç¸½å ±é…¬ç‡</div>
                    <div id="totalReturn" class="text-2xl font-bold">0%</div>
                </div>
            </div>

            <!-- ç¯©é¸å™¨ -->
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-4 mb-6 no-print">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="text-slate-300 font-medium">ç¯©é¸ï¼š</span>
                    <select id="filterRegion" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                        <option value="">å…¨éƒ¨åœ°å€</option>
                        <option value="å°è‚¡">å°è‚¡</option>
                        <option value="ç¾è‚¡">ç¾è‚¡</option>
                    </select>
                    <select id="filterHolder" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                        <option value="">å…¨éƒ¨æŒæœ‰äºº</option>
                        <option value="Rebecca">Rebecca</option>
                        <option value="Eric">Eric</option>
                        <option value="Ian">Ian</option>
                    </select>
                    <select id="filterPlatform" onchange="applyFilters()" class="bg-slate-700 text-slate-100 px-3 py-1.5 rounded border border-slate-600">
                        <option value="">å…¨éƒ¨å¹³å°</option>
                        <option value="è¤‡å§”è¨—">è¤‡å§”è¨—</option>
                        <option value="è­‰åˆ¸">è­‰åˆ¸</option>
                        <option value="ä¿¡è¨—">ä¿¡è¨—</option>
                    </select>
                    <button onclick="clearFilters()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>

            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-900 border-b border-slate-700">
                                <th class="px-3 py-3 text-left text-slate-300">åœ°å€</th>
                                <th class="px-3 py-3 text-left text-slate-300">å…¬å¸</th>
                                <th class="px-3 py-3 text-left text-slate-300">ä»£è™Ÿ</th>
                                <th class="px-3 py-3 text-right text-slate-300">æˆæœ¬åƒ¹</th>
                                <th class="px-3 py-3 text-right text-slate-300">è‚¡æ•¸</th>
                                <th class="px-3 py-3 text-right text-slate-300">æŠ•è³‡æˆæœ¬</th>
                                <th class="px-3 py-3 text-right text-slate-300">ç¾åƒ¹</th>
                                <th class="px-3 py-3 text-right text-slate-300">ç¾å€¼</th>
                                <th class="px-3 py-3 text-right text-slate-300">å ±é…¬ç‡</th>
                                <th class="px-3 py-3 text-left text-slate-300">æŒæœ‰äºº</th>
                                <th class="px-3 py-3 text-left text-slate-300">å¹³å°</th>
                                <th class="px-3 py-3 text-center text-slate-300 no-print">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr class="bg-blue-900 bg-opacity-20 border-b-2 border-blue-500 no-print">
                                <td class="px-3 py-2">
                                    <select id="newRegion" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                        <option>å°è‚¡</option>
                                        <option>ç¾è‚¡</option>
                                    </select>
                                </td>
                                <td class="px-3 py-2">
                                    <input type="text" id="newCompany" placeholder="å…¬å¸åç¨±" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm" readonly />
                                </td>
                                <td class="px-3 py-2">
                                    <input type="text" id="newSymbol" placeholder="ä»£è™Ÿ" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm font-mono" onchange="fetchCompanyName()" />
                                </td>
                                <td class="px-3 py-2">
                                    <input type="number" id="newCostPrice" placeholder="æˆæœ¬åƒ¹" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-right" onchange="calculateCost()" step="0.01" />
                                </td>
                                <td class="px-3 py-2">
                                    <input type="number" id="newShares" placeholder="è‚¡æ•¸" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-right" onchange="calculateCost()" />
                                </td>
                                <td class="px-3 py-2">
                                    <input type="number" id="newCost" placeholder="æˆæœ¬" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm text-right" onchange="calculateCostPrice()" />
                                </td>
                                <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•ç²å–</td>
                                <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•</td>
                                <td class="px-3 py-2 text-slate-500 text-right text-xs">è‡ªå‹•</td>
                                <td class="px-3 py-2">
                                    <select id="newHolder" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                        <option value="">é¸æ“‡</option>
                                        <option>Rebecca</option>
                                        <option>Eric</option>
                                        <option>Ian</option>
                                    </select>
                                </td>
                                <td class="px-3 py-2">
                                    <select id="newPlatform" class="w-full bg-slate-700 text-slate-100 px-2 py-1.5 rounded border border-slate-600 text-sm">
                                        <option>è¤‡å§”è¨—</option>
                                        <option>è­‰åˆ¸</option>
                                        <option>ä¿¡è¨—</option>
                                    </select>
                                </td>
                                <td class="px-3 py-2 text-center">
                                    <button onclick="addStock()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded">æ–°å¢</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 bg-blue-900 bg-opacity-30 border border-blue-700 border-opacity-50 rounded-lg p-4 text-sm text-blue-200">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong> 
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿå¾Œæœƒè‡ªå‹•ç²å–å…¬å¸åç¨±</li>
                    <li>è¼¸å…¥æˆæœ¬åƒ¹+è‚¡æ•¸æœƒè‡ªå‹•è¨ˆç®—æŠ•è³‡æˆæœ¬ï¼Œæˆ–è¼¸å…¥æŠ•è³‡æˆæœ¬+è‚¡æ•¸æœƒè‡ªå‹•è¨ˆç®—æˆæœ¬åƒ¹</li>
                    <li>ç³»çµ±æœƒè‡ªå‹•ç²å–æœ€æ–°è‚¡åƒ¹ï¼ˆè‹¥æœªé–‹ç›¤å‰‡é¡¯ç¤ºå‰ä¸€æ”¶ç›¤åƒ¹ï¼‰</li>
                    <li>é»æ“Šã€Œä¸€éµå…¨éƒ¨æ›´æ–°ã€å¯åŒæ™‚æ›´æ–°åŒ¯ç‡å’Œæ‰€æœ‰è‚¡åƒ¹</li>
                    <li>å¯ä½¿ç”¨ç¯©é¸åŠŸèƒ½æŸ¥çœ‹ç‰¹å®šåœ°å€ã€æŒæœ‰äººæˆ–å¹³å°çš„è‚¡ç¥¨</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        const { auth, db, provider, allowedEmails } = window.firebaseApp;
        let currentUser = null;
        let stocks = [];
        let filteredStocks = [];
        let autoRefreshInterval = null;

        import { onAuthStateChanged, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        onAuthStateChanged(auth, async (user) => {
            if (user && allowedEmails.includes(user.email)) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                await loadStocks();
                
                // é¦–æ¬¡åŠ è¼‰æ™‚æ›´æ–°åŒ¯ç‡
                await fetchExchangeRate();
                
                // å•Ÿå‹•è‡ªå‹•åˆ·æ–°
                if (document.getElementById('autoRefresh').checked) {
                    toggleAutoRefresh(true);
                }
            } else if (user) {
                alert('æ‚¨çš„å¸³è™Ÿç„¡æ¬Šè¨ªå•æ­¤ç³»çµ±');
                await auth.signOut();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // ç²å–è‚¡ç¥¨è³‡è¨Šï¼ˆåƒ¹æ ¼å’Œå…¬å¸åç¨±ï¼‰
        async function fetchStockInfo(symbol, region) {
            try {
                let apiSymbol = symbol;
                
                if (region === 'å°è‚¡') {
                    apiSymbol = symbol + '.TW';
                }
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${apiSymbol}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    
                    // ç²å–åƒ¹æ ¼ï¼ˆå„ªå…ˆä½¿ç”¨ regularMarketPriceï¼Œå¦å‰‡ä½¿ç”¨ previousCloseï¼‰
                    const price = meta.regularMarketPrice || meta.chartPreviousClose || meta.previousClose;
                    
                    // ç²å–å…¬å¸åç¨±
                    const companyName = meta.longName || meta.shortName || symbol;
                    
                    return {
                        price: Math.abs(price), // ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
                        companyName: companyName
                    };
                }
                
                return null;
            } catch (error) {
                console.error(`ç²å– ${symbol} è³‡è¨Šå¤±æ•—:`, error);
                return null;
            }
        }

        // ç²å–åŒ¯ç‡
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/USDTWD=X');
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const rate = data.chart.result[0].meta.regularMarketPrice || data.chart.result[0].meta.previousClose;
                    if (rate) {
                        document.getElementById('usdRate').value = Math.abs(rate).toFixed(2);
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('ç²å–åŒ¯ç‡å¤±æ•—:', error);
            }
        }

        // ç²å–å…¬å¸åç¨±ï¼ˆåœ¨è¼¸å…¥ä»£è™Ÿæ™‚ï¼‰
        window.fetchCompanyName = async function() {
            const symbol = document.getElementById('newSymbol').value.toUpperCase().trim();
            const region = document.getElementById('newRegion').value;
            
            if (!symbol) return;
            
            document.getElementById('newCompany').value = 'ç²å–ä¸­...';
            
            const info = await fetchStockInfo(symbol, region);
            if (info) {
                document.getElementById('newCompany').value = info.companyName;
            } else {
                document.getElementById('newCompany').value = '';
                alert('ç„¡æ³•ç²å–å…¬å¸åç¨±ï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£è™Ÿ');
            }
        };

        // è¨ˆç®—æŠ•è³‡æˆæœ¬ï¼ˆç•¶è¼¸å…¥æˆæœ¬åƒ¹æˆ–è‚¡æ•¸æ™‚ï¼‰
        window.calculateCost = function() {
            const costPrice = parseFloat(document.getElementById('newCostPrice').value);
            const shares = parseFloat(document.getElementById('newShares').value);
            
            if (costPrice && shares) {
                const totalCost = costPrice * shares;
                document.getElementById('newCost').value = totalCost.toFixed(2);
            }
        };

        // è¨ˆç®—æˆæœ¬åƒ¹ï¼ˆç•¶è¼¸å…¥æŠ•è³‡æˆæœ¬æˆ–è‚¡æ•¸æ™‚ï¼‰
        window.calculateCostPrice = function() {
            const totalCost = parseFloat(document.getElementById('newCost').value);
            const shares = parseFloat(document.getElementById('newShares').value);
            
            if (totalCost && shares && shares > 0) {
                const costPrice = totalCost / shares;
                document.getElementById('newCostPrice').value = costPrice.toFixed(2);
            }
        };

        // æ›´æ–°å–®å€‹è‚¡ç¥¨çš„åƒ¹æ ¼
        async function updateStockPrice(stockId, symbol, region) {
            const info = await fetchStockInfo(symbol, region);
            if (info && info.price) {
                const stockRef = doc(db, 'stocks', stockId);
                await updateDoc(stockRef, {
                    currentPrice: info.price,
                    lastPriceUpdate: new Date().toISOString()
                });
            }
        }

        // ä¸€éµæ›´æ–°æ‰€æœ‰ï¼ˆåŒ¯ç‡+è‚¡åƒ¹ï¼‰
        window.updateAllPricesAndRate = async function() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = 'ğŸ”„ æ›´æ–°ä¸­...<span class="loading-spinner"></span>';
            
            // åŒæ™‚æ›´æ–°åŒ¯ç‡å’Œæ‰€æœ‰è‚¡åƒ¹
            await Promise.all([
                fetchExchangeRate(),
                ...stocks.map(stock => updateStockPrice(stock.id, stock.symbol, stock.region))
            ]);
            
            button.disabled = false;
            button.innerHTML = 'ğŸ”„ ä¸€éµå…¨éƒ¨æ›´æ–°';
            updateLastUpdateTime();
        };

        // è‡ªå‹•åˆ·æ–°åŠŸèƒ½
        window.toggleAutoRefresh = function(enabled) {
            if (enabled) {
                autoRefreshInterval = setInterval(() => {
                    updateAllPricesAndRate();
                }, 5 * 60 * 1000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        };

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW');
            document.getElementById('lastUpdate').textContent = `æœ€å¾Œæ›´æ–°: ${timeStr}`;
        }

        // ç¯©é¸åŠŸèƒ½
        window.applyFilters = function() {
            const regionFilter = document.getElementById('filterRegion').value;
            const holderFilter = document.getElementById('filterHolder').value;
            const platformFilter = document.getElementById('filterPlatform').value;
            
            filteredStocks = stocks.filter(stock => {
                if (regionFilter && stock.region !== regionFilter) return false;
                if (holderFilter && stock.holder !== holderFilter) return false;
                if (platformFilter && stock.platform !== platformFilter) return false;
                return true;
            });
            
            renderStocks();
            updateStats();
        };

        window.clearFilters = function() {
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterHolder').value = '';
            document.getElementById('filterPlatform').value = '';
            filteredStocks = [...stocks];
            renderStocks();
            updateStats();
        };

        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        };

        window.logout = async () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                await auth.signOut();
            }
        };

        async function loadStocks() {
            const stocksRef = collection(db, 'stocks');
            onSnapshot(stocksRef, (snapshot) => {
                stocks = [];
                snapshot.forEach((doc) => {
                    stocks.push({ id: doc.id, ...doc.data() });
                });
                filteredStocks = [...stocks];
                renderStocks();
                updateStats();
            });
        }

        function renderStocks() {
            const tbody = document.getElementById('stockTableBody');
            const addRow = tbody.querySelector('tr');
            tbody.innerHTML = '';
            tbody.appendChild(addRow);

            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            displayStocks.forEach(stock => {
                // å…ˆé©—è­‰å’Œè½‰æ›æ‰€æœ‰æ•¸å€¼å­—æ®µï¼Œä¸¦ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
                stock.shares = parseFloat(stock.shares) || 0;
                stock.investmentCost = parseFloat(stock.investmentCost) || 0;
                stock.currentPrice = Math.abs(parseFloat(stock.currentPrice) || 0);
                stock.companyName = stock.companyName || '';
                                
                const calc = calculateFields(stock);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700 hover:bg-slate-750';
                
                const lastUpdate = stock.lastPriceUpdate ? new Date(stock.lastPriceUpdate).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'æœªæ›´æ–°';
                
                tr.innerHTML = `
                    <td class="px-3 py-3 text-slate-300">${stock.region || ''}</td>
                    <td class="px-3 py-3 text-slate-300">${stock.companyName || stock.symbol}</td>
                    <td class="px-3 py-3 text-slate-100 font-mono font-semibold">${stock.symbol}</td>
                    <td class="px-3 py-3 text-right text-slate-300 font-mono text-xs">${calc.costPrice.toFixed(2)}</td>
                    <td class="px-3 py-3 text-right text-slate-300 font-mono">${stock.shares.toLocaleString()}</td>
                    <td class="px-3 py-3 text-right text-slate-300 font-mono text-xs">${stock.investmentCost.toLocaleString()}</td>
                    <td class="px-3 py-3 text-right text-slate-300 font-mono text-xs" title="æœ€å¾Œæ›´æ–°: ${lastUpdate}">
                        ${Math.abs(stock.currentPrice).toFixed(2)}
                        <button onclick="updateStockPrice('${stock.id}', '${stock.symbol}', '${stock.region}')" class="ml-1 text-blue-400 hover:text-blue-300 text-xs">ğŸ”„</button>
                    </td>
                    <td class="px-3 py-3 text-right text-slate-300 font-mono text-xs">${calc.currentValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="px-3 py-3 text-right font-mono font-semibold ${calc.returnRate >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${calc.returnRate >= 0 ? '+' : ''}${calc.returnRate.toFixed(2)}%
                    </td>
                    <td class="px-3 py-3 text-slate-300">${stock.holder}</td>
                    <td class="px-3 py-3 text-slate-300">${stock.platform}</td>
                    <td class="px-3 py-3 text-center no-print">
                        <button onclick="deleteStock('${stock.id}')" class="text-red-400 hover:text-red-300">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateFields(stock) {
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31.5;
            const shares = parseFloat(stock.shares) || 0;
            const investmentCost = parseFloat(stock.investmentCost) || 0;
            const currentPrice = Math.abs(parseFloat(stock.currentPrice) || 0); // ç¢ºä¿åƒ¹æ ¼ç‚ºæ­£å€¼
            
            const costPrice = shares > 0 ? investmentCost / shares : 0;
            const currentValue = currentPrice * shares;
            const returnRate = investmentCost > 0 ? ((currentValue - investmentCost) / investmentCost) * 100 : 0;
            
            const currentValueTWD = stock.region === 'ç¾è‚¡' ? currentValue * usdRate : currentValue;
            const investmentCostTWD = stock.region === 'ç¾è‚¡' ? investmentCost * usdRate : investmentCost;
            
            return { costPrice, currentPrice, currentValue, currentValueTWD, investmentCostTWD, returnRate };
        }

        window.updateStats = function() {
            const usdRate = parseFloat(document.getElementById('usdRate').value) || 31.5;
            let totalCost = 0, totalValue = 0;

            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            displayStocks.forEach(stock => {
                const calc = calculateFields(stock);
                totalCost += calc.investmentCostTWD;
                totalValue += calc.currentValueTWD;
            });

            const profit = totalValue - totalCost;
            const returnRate = totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0;

            document.getElementById('totalCost').textContent = 'TWD ' + totalCost.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalValue').textContent = 'TWD ' + totalValue.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalProfit').textContent = 'TWD ' + profit.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalProfit').className = 'text-2xl font-bold ' + (profit >= 0 ? 'text-green-400' : 'text-red-400');
            document.getElementById('totalReturn').textContent = (returnRate >= 0 ? '+' : '') + returnRate.toFixed(2) + '%';
            document.getElementById('totalReturn').className = 'text-2xl font-bold ' + (returnRate >= 0 ? 'text-green-400' : 'text-red-400');
        }

        window.addStock = async () => {
            const region = document.getElementById('newRegion').value;
            const companyName = document.getElementById('newCompany').value;
            const symbol = document.getElementById('newSymbol').value.toUpperCase().trim();
            const shares = parseFloat(document.getElementById('newShares').value);
            const costPrice = parseFloat(document.getElementById('newCostPrice').value);
            const investmentCost = parseFloat(document.getElementById('newCost').value);
            const holder = document.getElementById('newHolder').value;
            const platform = document.getElementById('newPlatform').value;

            if (!symbol || !shares || !holder) {
                alert('è«‹å¡«å¯«è‚¡ç¥¨ä»£è™Ÿã€è‚¡æ•¸å’ŒæŒæœ‰äºº');
                return;
            }

            if (!costPrice && !investmentCost) {
                alert('è«‹å¡«å¯«æˆæœ¬åƒ¹æˆ–æŠ•è³‡æˆæœ¬');
                return;
            }

            // è¨ˆç®—ç¼ºå°‘çš„å€¼
            let finalCostPrice = costPrice;
            let finalInvestmentCost = investmentCost;
            
            if (!finalCostPrice && finalInvestmentCost) {
                finalCostPrice = finalInvestmentCost / shares;
            } else if (finalCostPrice && !finalInvestmentCost) {
                finalInvestmentCost = finalCostPrice * shares;
            }

            // è‡ªå‹•ç²å–ç•¶å‰åƒ¹æ ¼å’Œå…¬å¸åç¨±
            const info = await fetchStockInfo(symbol, region);
            if (!info || !info.price) {
                alert('ç„¡æ³•ç²å–è‚¡ç¥¨åƒ¹æ ¼ï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£è™Ÿæ˜¯å¦æ­£ç¢º');
                return;
            }

            const finalCompanyName = companyName || info.companyName;

            try {
                await addDoc(collection(db, 'stocks'), {
                    region, 
                    companyName: finalCompanyName, 
                    symbol, 
                    shares, 
                    investmentCost: finalInvestmentCost, 
                    currentPrice: Math.abs(info.price), 
                    holder, 
                    platform,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email,
                    lastPriceUpdate: new Date().toISOString()
                });

                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('newCompany').value = '';
                document.getElementById('newSymbol').value = '';
                document.getElementById('newShares').value = '';
                document.getElementById('newCostPrice').value = '';
                document.getElementById('newCost').value = '';
                document.getElementById('newHolder').value = '';
            } catch (error) {
                alert('æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        };

        window.deleteStock = async (id) => {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, 'stocks', id));
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        };

        window.updateStockPrice = updateStockPrice;

        window.exportToExcel = () => {
            const displayStocks = filteredStocks.length > 0 || 
                                  document.getElementById('filterRegion').value || 
                                  document.getElementById('filterHolder').value || 
                                  document.getElementById('filterPlatform').value 
                                  ? filteredStocks : stocks;

            const data = displayStocks.map(stock => {
                const calc = calculateFields(stock);
                return {
                    åœ°å€: stock.region,
                    å…¬å¸åç¨±: stock.companyName || stock.symbol,
                    è‚¡ç¥¨ä»£è™Ÿ: stock.symbol,
                    æˆæœ¬è‚¡åƒ¹: calc.costPrice.toFixed(2),
                    è‚¡æ•¸: stock.shares,
                    æŠ•è³‡æˆæœ¬: stock.investmentCost,
                    ç¾åƒ¹: Math.abs(stock.currentPrice).toFixed(2),
                    ç¾å€¼: calc.currentValue.toFixed(2),
                    å ±é…¬ç‡: calc.returnRate.toFixed(2) + '%',
                    æŒæœ‰äºº: stock.holder,
                    æŒæœ‰å¹³å°: stock.platform,
                    æœ€å¾Œæ›´æ–°: stock.lastPriceUpdate || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æŠ•è³‡çµ„åˆ');
            XLSX.writeFile(wb, `æŠ•è³‡çµ„åˆ_${new Date().toISOString().split('T')[0]}.xlsx`);
        };
    </script>
</body>
</html>
